# 温度数据记录模型

<cite>
**本文档引用的文件**
- [20190330170000_create_positions.exs](file://priv/repo/migrations/20190330170000_create_positions.exs)
- [20190415103933_add_inside_temp.exs](file://priv/repo/migrations/20190415103933_add_inside_temp.exs)
- [position.ex](file://lib/teslamate/log/position.ex)
- [drive.ex](file://lib/teslamate/log/drive.ex)
- [log.ex](file://lib/teslamate/log.ex)
- [vehicle.ex](file://lib/teslamate/vehicles/vehicle.ex)
- [car_settings.ex](file://lib/teslamate/settings/car_settings.ex)
- [environment_variables.md](file://website/docs/configuration/environment_variables.md)
</cite>

## 目录
1. [温度数据存储位置](#温度数据存储位置)
2. [数据记录机制](#数据记录机制)
3. [设计决策分析](#设计决策分析)
4. [trips表中的inside_temp_avg计算](#trips表中的inside_temp_avg计算)
5. [数据采样频率与类型](#数据采样频率与类型)
6. [查询示例](#查询示例)

## 温度数据存储位置

车内温度（inside_temp）和车外温度（outside_temp）数据存储在positions表中，而非states表。这种设计决策基于车辆位置和环境数据的高频率关联需求。

positions表包含了车辆在特定时间点的完整状态快照，包括位置、速度、电量以及温度信息。通过将温度数据与位置数据存储在同一表中，系统能够高效地关联车辆的地理位置与环境温度条件。

**Section sources**
- [20190330170000_create_positions.exs](file://priv/repo/migrations/20190330170000_create_positions.exs#L1-L28)
- [position.ex](file://lib/teslamate/log/position.ex#L1-L79)

## 数据记录机制

温度数据的记录机制与车辆状态监控系统紧密集成。系统通过Tesla API定期获取车辆状态，当车辆处于活动状态时，会高频次地记录位置和环境数据。

数据记录流程如下：
1. 系统通过API轮询或流式连接获取车辆状态
2. 解析车辆状态中的气候数据（climate_state）
3. 将解析得到的inside_temp和outside_temp值与位置信息一起存储到positions表
4. 在车辆状态变化时，更新相应的状态记录

**Section sources**
- [vehicle.ex](file://lib/teslamate/vehicles/vehicle.ex#L1-L800)
- [log.ex](file://lib/teslamate/log.ex#L1-L712)

## 设计决策分析

将温度数据存储在positions表而非states表的设计决策基于以下几个关键因素：

1. **高频率数据关联**：位置数据和温度数据都是高频变化的环境参数，将它们存储在同一表中可以确保数据的时间同步性，便于分析车辆位置与环境温度的关系。

2. **数据完整性**：每个位置记录都包含完整的环境快照，避免了跨表关联查询的复杂性和性能开销。

3. **查询效率**：对于需要分析特定路线温度变化的场景，单表查询比多表关联查询更高效。

4. **数据粒度**：位置数据的采样频率远高于状态变化频率，将温度数据与位置数据绑定可以保持更高的时间分辨率。

这种设计特别适用于分析车辆在不同地理位置的温度变化模式，以及温度对车辆性能（如电池效率）的影响。

**Section sources**
- [20190330170000_create_positions.exs](file://priv/repo/migrations/20190330170000_create_positions.exs#L1-L28)
- [20190415103933_add_inside_temp.exs](file://priv/repo/migrations/20190415103933_add_inside_temp.exs#L1-L13)

## trips表中的inside_temp_avg计算

trips表中的inside_temp_avg字段存储了行程期间车内温度的平均值。该值在行程结束时通过聚合positions表中的相关数据计算得出。

计算过程如下：
1. 当行程结束时，系统查询该行程关联的所有位置记录
2. 使用SQL的AVG函数计算这些记录中inside_temp字段的平均值
3. 将计算结果更新到trips表的inside_temp_avg字段

在代码实现中，这一计算通过Ecto查询的窗口函数完成：
```elixir
outside_temp_avg: avg(p.outside_temp) |> over(:w),
inside_temp_avg: avg(p.inside_temp) |> over(:w)
```

这种设计使得行程级别的温度统计信息可以直接从trips表获取，而无需实时计算，提高了查询性能。

**Section sources**
- [20190415103933_add_inside_temp.exs](file://priv/repo/migrations/20190415103933_add_inside_temp.exs#L1-L13)
- [drive.ex](file://lib/teslamate/log/drive.ex#L1-L79)
- [log.ex](file://lib/teslamate/log.ex#L251-L253)

## 数据采样频率与类型

温度数据的采样频率根据车辆状态动态调整：

- **行驶中**：每2.5秒采样一次
- **充电中**：每5秒采样一次
- **在线状态**：每60秒采样一次
- **休眠状态**：每30秒采样一次

这些采样频率可以通过环境变量进行配置，但建议保持默认值以避免对Tesla API造成过大压力。

数据类型方面：
- inside_temp和outside_temp字段均为浮点数（float）类型
- 允许空值（NULL），当车辆API未提供温度数据时
- 温度值以摄氏度为单位存储

采样频率的配置可以在环境变量中进行调整，主要相关变量包括：
- POLLING_DRIVING_INTERVAL
- POLLING_CHARGING_INTERVAL
- POLLING_ONLINE_INTERVAL
- POLLING_ASLEEP_INTERVAL

**Section sources**
- [car_settings.ex](file://lib/teslamate/settings/car_settings.ex#L1-L36)
- [environment_variables.md](file://website/docs/configuration/environment_variables.md#L52-L57)

## 查询示例

以下SQL查询示例展示了如何从positions表中提取特定时间段内的温度变化序列：

```sql
SELECT 
    date,
    latitude,
    longitude,
    inside_temp,
    outside_temp,
    speed,
    battery_level
FROM positions 
WHERE car_id = ? 
    AND date BETWEEN ? AND ?
    AND inside_temp IS NOT NULL
    AND outside_temp IS NOT NULL
ORDER BY date ASC;
```

此查询可用于分析温度变化与车辆状态的关系，例如：

1. **温度与电池效率关系分析**：
```sql
SELECT 
    AVG(inside_temp) as avg_inside_temp,
    AVG(outside_temp) as avg_outside_temp,
    (MAX(battery_level) - MIN(battery_level)) as battery_consumption,
    AVG(speed) as avg_speed
FROM positions 
WHERE car_id = ? 
    AND date BETWEEN ? AND ?
GROUP BY DATE_TRUNC('hour', date);
```

2. **极端温度条件下的车辆性能分析**：
```sql
SELECT 
    date,
    inside_temp,
    outside_temp,
    battery_level,
    power
FROM positions 
WHERE car_id = ? 
    AND date BETWEEN ? AND ?
    AND (outside_temp > 35 OR outside_temp < 0)
ORDER BY date;
```

3. **空调系统效能分析**：
```sql
SELECT 
    date,
    inside_temp,
    outside_temp,
    is_climate_on,
    driver_temp_setting,
    passenger_temp_setting
FROM positions 
WHERE car_id = ? 
    AND date BETWEEN ? AND ?
    AND is_climate_on = true
ORDER BY date;
```

这些查询示例展示了如何利用positions表中的温度数据进行多维度分析，包括温度变化趋势、能耗模式以及气候控制系统性能评估。

**Section sources**
- [position.ex](file://lib/teslamate/log/position.ex#L1-L79)
- [log.ex](file://lib/teslamate/log.ex#L1-L712)
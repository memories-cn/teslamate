# 驾驶记录完整性约束

<cite>
**本文档中引用的文件**  
- [drive.ex](file://lib/teslamate/log/drive.ex)
- [position.ex](file://lib/teslamate/log/position.ex)
- [address.ex](file://lib/teslamate/locations/address.ex)
- [geo_fence.ex](file://lib/teslamate/locations/geo_fence.ex)
- [log.ex](file://lib/teslamate/log.ex)
- [vehicle.ex](file://lib/teslamate/vehicles/vehicle.ex)
- [add_constraints.exs](file://priv/repo/migrations/20190821143938_add_constraints.exs)
- [cascade_delete.exs](file://priv/repo/migrations/20200203120311_cascade_delete.exs)
</cite>

## 目录
1. [引言](#引言)
2. [驾驶数据模型完整性约束](#驾驶数据模型完整性约束)
3. [应用层验证规则](#应用层验证规则)
4. [数据验证流程与变更集实现](#数据验证流程与变更集实现)
5. [异常驾驶记录处理策略](#异常驾驶记录处理策略)
6. [常见数据异常诊断与修复](#常见数据异常诊断与修复)

## 引言
本文档全面记录TeslaMate系统中驾驶数据模型的完整性约束和验证规则。文档详细说明了非空约束、外键约束和自定义检查约束的实现方式，解释了系统如何处理不完整或异常的驾驶记录，并描述了数据验证流程在变更集（changeset）中的实现机制。通过数据库约束和应用层验证双重保障数据质量，确保驾驶记录的准确性和一致性。

## 驾驶数据模型完整性约束

```mermaid
erDiagram
DRIVES {
integer id PK
datetime start_date
datetime end_date
decimal outside_temp_avg
decimal inside_temp_avg
integer speed_max
integer power_max
integer power_min
decimal start_ideal_range_km
decimal end_ideal_range_km
decimal start_rated_range_km
decimal end_rated_range_km
float start_km
float end_km
float distance
integer duration_min
integer ascent
integer descent
}
POSITIONS {
integer id PK
datetime date
decimal latitude
decimal longitude
integer elevation
integer speed
integer power
float odometer
decimal ideal_battery_range_km
decimal est_battery_range_km
decimal rated_battery_range_km
integer battery_level
integer usable_battery_level
boolean battery_heater
boolean battery_heater_on
boolean battery_heater_no_power
decimal outside_temp
decimal inside_temp
integer fan_status
decimal driver_temp_setting
decimal passenger_temp_setting
boolean is_climate_on
boolean is_rear_defroster_on
boolean is_front_defroster_on
decimal tpms_pressure_fl
decimal tpms_pressure_fr
decimal tpms_pressure_rl
decimal tpms_pressure_rr
}
ADDRESSES {
integer id PK
string city
string county
string country
string display_name
string house_number
decimal latitude
decimal longitude
string name
string neighbourhood
integer osm_id
string osm_type
string postcode
string road
string state
string state_district
map raw
}
GEOFENCES {
integer id PK
string name
decimal latitude
decimal longitude
integer radius
enum billing_type
decimal cost_per_unit
decimal session_fee
}
CARS {
integer id PK
}
DRIVES ||--o{ POSITIONS : "has_many"
DRIVES }o--|| CARS : "belongs_to"
DRIVES }o--|| POSITIONS : "start_position"
DRIVES }o--|| POSITIONS : "end_position"
DRIVES }o--|| ADDRESSES : "start_address"
DRIVES }o--|| ADDRESSES : "end_address"
DRIVES }o--|| GEOFENCES : "start_geofence"
DRIVES }o--|| GEOFENCES : "end_geofence"
```

**图示来源**
- [drive.ex](file://lib/teslamate/log/drive.ex#L8-L39)
- [position.ex](file://lib/teslamate/log/position.ex#L7-L38)
- [address.ex](file://lib/teslamate/locations/address.ex#L5-L23)
- [geo_fence.ex](file://lib/teslamate/locations/geo_fence.ex#L6-L16)

**本节来源**
- [drive.ex](file://lib/teslamate/log/drive.ex)
- [position.ex](file://lib/teslamate/log/position.ex)
- [address.ex](file://lib/teslamate/locations/address.ex)
- [geo_fence.ex](file://lib/teslamate/locations/geo_fence.ex)

## 应用层验证规则

```mermaid
classDiagram
class Drive {
+start_date : utc_datetime_usec
+end_date : utc_datetime_usec
+outside_temp_avg : decimal
+inside_temp_avg : decimal
+speed_max : integer
+power_max : integer
+power_min : integer
+start_ideal_range_km : decimal
+end_ideal_range_km : decimal
+start_rated_range_km : decimal
+end_rated_range_km : decimal
+start_km : float
+end_km : float
+distance : float
+duration_min : integer
+ascent : integer
+descent : integer
}
class Position {
+date : utc_datetime_usec
+latitude : decimal
+longitude : decimal
+elevation : integer
+speed : integer
+power : integer
+odometer : float
+ideal_battery_range_km : decimal
+est_battery_range_km : decimal
+rated_battery_range_km : decimal
+battery_level : integer
+usable_battery_level : integer
+battery_heater : boolean
+battery_heater_on : boolean
+battery_heater_no_power : boolean
+outside_temp : decimal
+inside_temp : decimal
+fan_status : integer
+driver_temp_setting : decimal
+passenger_temp_setting : decimal
+is_climate_on : boolean
+is_rear_defroster_on : boolean
+is_front_defroster_on : boolean
+tpms_pressure_fl : decimal
+tpms_pressure_fr : decimal
+tpms_pressure_rl : decimal
+tpms_pressure_rr : decimal
}
class Address {
+city : string
+county : string
+country : string
+display_name : string
+house_number : string
+latitude : decimal
+longitude : decimal
+name : string
+neighbourhood : string
+osm_id : integer
+osm_type : string
+postcode : string
+raw : map
+road : string
+state : string
+state_district : string
}
class GeoFence {
+name : string
+latitude : decimal
+longitude : decimal
+radius : integer
+billing_type : Ecto.Enum
+cost_per_unit : decimal
+session_fee : decimal
}
Drive : +changeset(drive, attrs)
Position : +changeset(position, attrs)
Address : +changeset(address, attrs)
GeoFence : +changeset(geofence, attrs)
Drive --> Position : "belongs_to"
Drive --> Address : "belongs_to"
Drive --> GeoFence : "belongs_to"
Drive --> Car : "belongs_to"
Drive --> Position : "has_many"
Position --> Car : "belongs_to"
Position --> Drive : "belongs_to"
```

**图示来源**
- [drive.ex](file://lib/teslamate/log/drive.ex#L42-L77)
- [position.ex](file://lib/teslamate/log/position.ex#L42-L76)
- [address.ex](file://lib/teslamate/locations/address.ex#L27-L55)
- [geo_fence.ex](file://lib/teslamate/locations/geo_fence.ex#L20-L35)

**本节来源**
- [drive.ex](file://lib/teslamate/log/drive.ex#L42-L77)
- [position.ex](file://lib/teslamate/log/position.ex#L42-L76)
- [address.ex](file://lib/teslamate/locations/address.ex#L27-L55)
- [geo_fence.ex](file://lib/teslamate/locations/geo_fence.ex#L20-L35)

## 数据验证流程与变更集实现

```mermaid
sequenceDiagram
participant Vehicle as "车辆"
participant VehicleModule as "Vehicle模块"
participant LogModule as "Log模块"
participant Repo as "数据库仓库"
Vehicle->>VehicleModule : 发送驾驶状态
VehicleModule->>VehicleModule : 处理流数据
alt 驾驶开始
VehicleModule->>LogModule : start_drive(position)
LogModule->>Repo : 插入驾驶记录
Repo-->>LogModule : 返回驾驶对象
LogModule->>Repo : 插入位置记录
Repo-->>LogModule : 返回位置对象
LogModule->>LogModule : 创建变更集
LogModule->>Repo : 更新驾驶记录
end
alt 驾驶进行中
Vehicle->>VehicleModule : 持续发送位置数据
VehicleModule->>LogModule : insert_position(drive, position)
LogModule->>Repo : 插入位置记录
Repo-->>LogModule : 返回位置对象
end
alt 驾驶结束或超时
VehicleModule->>LogModule : close_drive(drive)
LogModule->>Repo : 查询驾驶数据
Repo-->>LogModule : 返回聚合数据
LogModule->>LogModule : 计算距离、时长等
LogModule->>LogModule : 查找起止位置
LogModule->>LogModule : 查找起止地址
LogModule->>LogModule : 查找起止地理围栏
LogModule->>LogModule : 创建变更集
LogModule->>Repo : 更新驾驶记录
end
```

**图示来源**
- [vehicle.ex](file://lib/teslamate/vehicles/vehicle.ex#L1545-L1559)
- [log.ex](file://lib/teslamate/log.ex#L329-L374)
- [log.ex](file://lib/teslamate/log.ex#L377-L393)

**本节来源**
- [log.ex](file://lib/teslamate/log.ex#L329-L393)
- [vehicle.ex](file://lib/teslamate/vehicles/vehicle.ex#L1545-L1567)

## 异常驾驶记录处理策略

```mermaid
flowchart TD
Start([开始]) --> CheckData["检查驾驶数据完整性"]
CheckData --> DataValid{"数据有效?"}
DataValid --> |否| HandleInvalid["处理无效数据"]
DataValid --> |是| CalculateDistance["计算行驶距离"]
CalculateDistance --> DistanceValid{"距离有效?"}
DistanceValid --> |否| DeleteDrive["删除驾驶记录<br/>距离=0, 时长=0"]
DistanceValid --> |是| CheckCount["检查位置点数量"]
CheckCount --> CountValid{"位置点>=2?"}
CountValid --> |否| DeleteDrive
CountValid --> |是| LookupAddress["查找起止地址"]
LookupAddress --> FindGeofence["查找起止地理围栏"]
FindGeofence --> UpdateDrive["更新驾驶记录<br/>包含地址和地理围栏"]
UpdateDrive --> End([结束])
HandleInvalid --> End
DeleteDrive --> End
```

**图示来源**
- [log.ex](file://lib/teslamate/log.ex#L346-L374)

**本节来源**
- [log.ex](file://lib/teslamate/log.ex#L346-L374)
- [vehicle.ex](file://lib/teslamate/vehicles/vehicle.ex#L369-L387)

## 常见数据异常诊断与修复

```mermaid
flowchart TD
Start([诊断开始]) --> CheckNull["检查必需字段为空"]
CheckNull --> NullFound{"发现空值?"}
NullFound --> |是| ReportNull["报告空值错误<br/>car_id, start_date"]
NullFound --> |否| CheckForeignKey["检查外键约束"]
CheckForeignKey --> FKInvalid{"外键无效?"}
FKInvalid --> |是| ReportFK["报告外键错误<br/>位置、地址、地理围栏"]
FKInvalid --> |否| CheckCustom["检查自定义约束"]
CheckCustom --> CustomInvalid{"自定义约束失败?"}
CustomInvalid --> |是| ReportCustom["报告自定义约束错误<br/>半径范围、费用非负"]
CustomInvalid --> |否| CheckDataIntegrity["检查数据完整性"]
CheckDataIntegrity --> IntegrityInvalid{"完整性问题?"}
IntegrityInvalid --> |是| ReportIntegrity["报告完整性问题<br/>起止日期顺序"]
IntegrityInvalid --> |否| NoIssues["无问题"]
ReportNull --> End([结束])
ReportFK --> End
ReportCustom --> End
ReportIntegrity --> End
NoIssues --> End
```

**图示来源**
- [drive.ex](file://lib/teslamate/log/drive.ex#L69-L76)
- [geo_fence.ex](file://lib/teslamate/locations/geo_fence.ex#L31-L34)
- [add_constraints.exs](file://priv/repo/migrations/20190821143938_add_constraints.exs#L6-L7)

**本节来源**
- [drive.ex](file://lib/teslamate/log/drive.ex#L69-L76)
- [geo_fence.ex](file://lib/teslamate/locations/geo_fence.ex#L31-L34)
- [add_constraints.exs](file://priv/repo/migrations/20190821143938_add_constraints.exs)
- [cascade_delete.exs](file://priv/repo/migrations/20200203120311_cascade_delete.exs)
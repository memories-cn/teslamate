# 安装指南

<cite>
**本文档中引用的文件**  
- [README.md](file://README.md)
- [Dockerfile](file://Dockerfile)
- [entrypoint.sh](file://entrypoint.sh)
- [config.exs](file://config/config.exs)
- [runtime.exs](file://config/runtime.exs)
- [docker.md](file://website/docs/installation/docker.md)
- [nixos.md](file://website/docs/installation/nixos.md)
- [environment_variables.md](file://website/docs/configuration/environment_variables.md)
- [traefik.md](file://website/docs/advanced_guides/traefik.md)
- [module.nix](file://nix/module.nix)
- [flake.nix](file://flake.nix)
- [Makefile](file://Makefile)
</cite>

## 目录
1. [简介](#简介)
2. [Docker安装](#docker安装)
3. [NixOS安装](#nixos安装)
4. [其他系统安装](#其他系统安装)
5. [故障排除](#故障排除)
6. [验证安装](#验证安装)

## 简介

TeslaMate是一个强大的自托管特斯拉车辆数据记录器，使用Elixir编写，数据存储在PostgreSQL数据库中，并通过Grafana进行可视化分析。本指南详细介绍了所有支持的安装方法，重点介绍Docker和NixOS安装流程，以及常见问题的解决方案。

**Section sources**
- [README.md](file://README.md#L1-L88)

## Docker安装

### 环境准备

在开始Docker安装之前，请确保系统满足以下要求：
- 已安装Docker和Docker Compose
- 机器持续在线以确保数据连续采集
- 至少1GB内存（推荐2GB以上）
- 外网访问权限以连接特斯拉API

### 配置文件设置

创建`docker-compose.yml`文件，包含TeslaMate、PostgreSQL、Grafana和Mosquitto服务：

```yml
services:
  teslamate:
    image: teslamate/teslamate:latest
    restart: always
    environment:
      - ENCRYPTION_KEY=secretkey
      - DATABASE_USER=teslamate
      - DATABASE_PASS=password
      - DATABASE_NAME=teslamate
      - DATABASE_HOST=database
      - MQTT_HOST=mosquitto
    ports:
      - 4000:4000
    volumes:
      - ./import:/opt/app/import
    cap_drop:
      - all

  database:
    image: postgres:18-trixie
    restart: always
    environment:
      - POSTGRES_USER=teslamate
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=teslamate
    volumes:
      - teslamate-db:/var/lib/postgresql

  grafana:
    image: teslamate/grafana:latest
    restart: always
    environment:
      - DATABASE_USER=teslamate
      - DATABASE_PASS=password
      - DATABASE_NAME=teslamate
      - DATABASE_HOST=database
    ports:
      - 3000:3000
    volumes:
      - teslamate-grafana-data:/var/lib/grafana

  mosquitto:
    image: eclipse-mosquitto:2
    restart: always
    command: mosquitto -c /mosquitto-no-auth.conf
    volumes:
      - mosquitto-conf:/mosquitto/config
      - mosquitto-data:/mosquitto/data

volumes:
  teslamate-db:
  teslamate-grafana-data:
  mosquitto-conf:
  mosquitto-data:
```

### 环境变量配置

关键环境变量配置说明：

| 环境变量 | 说明 | 默认值 |
|---------|------|-------|
| **ENCRYPTION_KEY** | 用于加密特斯拉API令牌的密钥（必需） | |
| **DATABASE_USER** | 数据库用户名 | |
| **DATABASE_PASS** | 数据库密码 | |
| **DATABASE_NAME** | 连接的数据库名称 | |
| **DATABASE_HOST** | 数据库服务器主机名 | |
| **DATABASE_PORT** | 数据库服务器端口 | 5432 |
| **VIRTUAL_HOST** | 应用程序中生成URL的主机部分 | localhost |
| **URL_PATH** | 生成URL的路径前缀 | / |
| **PORT** | Web界面暴露的端口 | 4000 |
| **MQTT_HOST** | MQTT代理主机名 | |
| **MQTT_PORT** | MQTT代理端口 | 1883 |

### 网络设置

Docker安装中的网络配置最佳实践：
- 使用默认的bridge网络，容器通过服务名称相互通信
- TeslaMate通过`database`连接PostgreSQL，通过`mosquitto`连接MQTT代理
- 端口映射：4000端口用于TeslaMate Web界面，3000端口用于Grafana

### 卷挂载最佳实践

卷挂载配置建议：
- `./import:/opt/app/import`：挂载导入目录，用于导入TeslaFi等数据
- 使用命名卷（named volumes）存储数据库和Grafana数据，确保数据持久化
- 数据库卷：`teslamate-db:/var/lib/postgresql`
- Grafana卷：`teslamate-grafana-data:/var/lib/grafana`
- Mosquitto配置和数据卷：`mosquitto-conf`和`mosquitto-data`

### 启动服务

使用以下命令启动服务：

```bash
docker compose up -d
```

### 高级配置

对于需要公网访问的场景，推荐使用Traefik反向代理：

```yml
services:
  teslamate:
    # ... 其他配置
    labels:
      traefik.enable: "true"
      traefik.http.services.teslamate.loadbalancer.server.port: "4000"
      traefik.http.middlewares.teslamate-auth.basicauth.usersfile: "/auth/.htpasswd"
      traefik.http.routers.teslamate.rule: "Host(`${FQDN_TM}`)"
      traefik.http.routers.teslamate.middlewares: "teslamate-auth"
      traefik.http.routers.teslamate.entrypoints: "websecure"
      traefik.http.routers.teslamate.tls.certresolver: "tmhttpchallenge"
```

**Section sources**
- [docker.md](file://website/docs/installation/docker.md#L1-L103)
- [environment_variables.md](file://website/docs/configuration/environment_variables.md#L1-L62)
- [traefik.md](file://website/docs/advanced_guides/traefik.md#L1-L182)

## NixOS安装

### 系统要求

NixOS安装需要满足以下条件：
- NixOS系统且已启用Nix flakes功能
- 持续在线的机器
- 至少1GB内存（推荐2GB以上）
- 外网访问权限

### 模块配置

TeslaMate提供了NixOS模块，通过flake集成：

```nix
{
  inputs = {
    teslamate.url = "github:teslamate-org/teslamate/main";
  };
}
```

要固定到特定版本，可以使用：

```nix
teslamate.url = "github:teslamate-org/teslamate?rev=c37638b320e0beea97c5d51fea51cd9fdbd07ce0"; # v2.0.0
```

对于MCU2升级的车辆：

```nix
teslamate.url = "github:teslamate-org/teslamate/mcu2-upgraded-cars";
```

### 系统集成

在NixOS配置中启用TeslaMate服务：

```nix
{
  config,
  lib,
  inputs,
  ...
}:
{
  imports = [ inputs.teslamate.nixosModules.default ];

  config = services.teslamate = {
    enable = true;
    secretsFile = "/run/secrets/teslamate.env";
    autoStart = true;
    listenAddress = "127.0.0.1";
    port = 4000;
    virtualHost = "$[your-domain]";
    urlPath = "/";

    postgres = {
      enable_server = true;
      user = "teslamate";
      database = "teslamate";
      host = "127.0.0.1";
      port = 5432;
    };

    grafana = {
      enable = true;
      listenAddress = "127.0.0.1";
      port = 3000;
      urlPath = "/";
    };

    mqtt = {
      enable = true;
      host = "127.0.0.1";
      port = 1883;
    };
  };
}
```

### 与反向代理集成

如果使用Caddy作为反向代理：

```nix
{
  services.caddy.virtualHosts."[your-sub-domain for TeslaMate]" = {
    useACMEHost = "[your-baseDomain]";
    extraConfig = ''
      reverse_proxy http://127.0.0.1:4000
    '';
  };

  services.caddy.virtualHosts."[your-sub-domain for grafana]" = {
    useACMEHost = "[your-baseDomain]";
    extraConfig = ''
      reverse_proxy http://127.0.0.1:3000
    '';
  };
}
```

**Section sources**
- [nixos.md](file://website/docs/installation/nixos.md#L1-L112)
- [module.nix](file://nix/module.nix#L1-L368)
- [flake.nix](file://flake.nix#L1-L35)

## 其他系统安装

### 通用构建说明

对于不支持的系统，可以手动构建和运行TeslaMate：

1. **安装依赖**：
   - Elixir (v1.16+)
   - Erlang (v25+)
   - PostgreSQL (v16.7+, v17.3+ 或 v18.0+)
   - Grafana (v12.0.1+)
   - Mosquitto (MQTT代理)
   - Node.js (v20+)

2. **构建过程**：
   ```bash
   make teslamate
   make grafana
   ```

3. **运行**：
   ```bash
   docker run -d --name teslamate teslamate/teslamate:latest
   ```

### Debian/Ubuntu安装

对于Debian或Ubuntu系统：

```bash
# PostgreSQL
sudo apt install postgresql-17 postgresql-client-17

# Elixir
sudo apt install erlang erlang-dev erlang-syntax-tools elixir

# Grafana
sudo apt-get install -y apt-transport-https software-properties-common
sudo add-apt-repository "deb https://packages.grafana.com/oss/deb stable main"
sudo apt-get update
sudo apt-get install -y grafana

# Mosquitto
sudo apt-get install -y mosquitto

# Node.js
curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
sudo apt-get install -y nodejs
```

### FreeBSD安装

对于FreeBSD系统：

```bash
# 基础工具
pkg install bash jq git

# Erlang和Elixir
pkg install erlang elixir

# PostgreSQL
pkg install postgresql18-server postgresql18-contrib
echo postgres_enable="yes" >> /etc/rc.conf
service postgresql initdb

# Grafana
pkg install grafana
echo grafana_enable="yes" >> /etc/rc.conf

# Mosquitto
pkg install mosquitto
echo mosquitto_enable="yes" >> /etc/rc.conf

# Node.js
pkg install node20 npm-node20
```

**Section sources**
- [debian.md](file://website/docs/installation/unsupported/debian.md#L1-L89)
- [freebsd.md](file://website/docs/installation/unsupported/freebsd.md#L1-L101)
- [Makefile](file://Makefile#L1-L20)

## 故障排除

### 数据库连接失败

常见原因及解决方案：

1. **PostgreSQL服务未启动**：
   ```bash
   # 检查PostgreSQL状态
   docker ps | grep postgres
   # 或在NixOS中
   systemctl status postgresql
   ```

2. **数据库凭据错误**：
   - 确认`DATABASE_USER`、`DATABASE_PASS`和`DATABASE_NAME`匹配
   - 在Docker中确保`POSTGRES_USER`和`POSTGRES_PASSWORD`一致

3. **网络连接问题**：
   ```bash
   # 测试数据库连接
   docker exec -it teslamate-container nc -z database 5432
   ```

4. **权限问题**：
   - 确保数据库用户有足够权限
   - 在NixOS中检查`services.teslamate.postgres.user`配置

### 权限错误

常见权限问题及解决方案：

1. **文件系统权限**：
   ```bash
   # 确保导入目录可读写
   chmod -R 755 ./import
   chown -R 1000:1000 ./import
   ```

2. **Docker容器权限**：
   - TeslaMate容器使用非root用户（UID 10000）
   - 确保挂载卷的权限正确

3. **NixOS服务权限**：
   - 服务以`teslamate`用户运行
   - 检查`users.users.teslamate`配置

### 网络配置问题

网络相关问题的排查：

1. **端口冲突**：
   ```bash
   # 检查端口占用
   netstat -tlnp | grep :4000
   lsof -i :4000
   ```

2. **防火墙阻止**：
   ```bash
   # 开放必要端口
   sudo ufw allow 4000
   sudo ufw allow 3000
   ```

3. **反向代理配置**：
   - 确保`VIRTUAL_HOST`和`URL_PATH`正确设置
   - 在Traefik配置中检查路由规则

4. **MQTT连接问题**：
   ```bash
   # 测试MQTT连接
   mosquitto_sub -h localhost -p 1883 -t 'teslamate/#' -v
   ```

### 其他常见问题

1. **加密密钥问题**：
   - 确保`ENCRYPTION_KEY`在重启后保持一致
   - 密钥更改会导致API令牌无法解密

2. **时区配置**：
   ```bash
   # 设置正确的时区
   environment:
     - TZ=Asia/Shanghai
   ```

3. **资源不足**：
   - 增加内存分配
   - 调整数据库连接池大小

**Section sources**
- [runtime.exs](file://config/runtime.exs#L1-L190)
- [entrypoint.sh](file://entrypoint.sh#L1-L24)
- [docker.md](file://website/docs/installation/docker.md#L1-L103)

## 验证安装

### Docker安装验证

1. **检查容器状态**：
   ```bash
   docker compose ps
   ```

2. **查看日志**：
   ```bash
   docker compose logs teslamate
   ```

3. **访问Web界面**：
   - 打开 `http://localhost:4000`
   - 使用特斯拉账户登录

4. **验证Grafana**：
   - 打开 `http://localhost:3000`
   - 使用默认凭据登录（admin/admin）

### NixOS安装验证

1. **检查服务状态**：
   ```bash
   systemctl status teslamate
   systemctl status postgresql
   systemctl status grafana
   ```

2. **查看服务日志**：
   ```bash
   journalctl -u teslamate -f
   ```

3. **测试API连接**：
   ```bash
   curl http://localhost:4000/health
   ```

### 功能验证

1. **数据采集验证**：
   - 检查车辆数据是否正常更新
   - 验证驾驶记录和充电记录

2. **Grafana仪表板**：
   - 确认所有预置仪表板正常显示
   - 检查数据源连接

3. **MQTT发布**：
   ```bash
   mosquitto_sub -h localhost -p 1883 -t 'teslamate/#' -v
   ```

4. **备份功能**：
   - 测试备份脚本
   - 验证数据完整性

**Section sources**
- [docker.md](file://website/docs/installation/docker.md#L94-L103)
- [nixos.md](file://website/docs/installation/nixos.md#L93-L112)
- [README.md](file://README.md#L1-L88)
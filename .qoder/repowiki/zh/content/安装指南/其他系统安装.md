# 其他系统安装

<cite>
**本文档中引用的文件**  
- [README.md](file://README.md)
- [mix.exs](file://mix.exs)
- [config.exs](file://config/config.exs)
- [prod.exs](file://config/prod.exs)
- [runtime.exs](file://config/runtime.exs)
- [entrypoint.sh](file://entrypoint.sh)
- [Makefile](file://Makefile)
- [package.json](file://assets/package.json)
- [build.js](file://assets/scripts/build.js)
- [debian.md](file://website/docs/installation/unsupported/debian.md)
- [freebsd.md](file://website/docs/installation/unsupported/freebsd.md)
- [unraid.md](file://website/docs/installation/unsupported/unraid.md)
- [environment_variables.md](file://website/docs/configuration/environment_variables.md)
</cite>

## 目录
1. [简介](#简介)
2. [系统要求](#系统要求)
3. [Debian/Ubuntu 安装指南](#debianubuntu-安装指南)
4. [FreeBSD 安装指南](#freebsd-安装指南)
5. [Unraid 安装指南](#unraid-安装指南)
6. [通用构建流程](#通用构建流程)
7. [环境变量配置](#环境变量配置)
8. [故障排除](#故障排除)
9. [维护与更新](#维护与更新)

## 简介

TeslaMate 是一个强大的自托管特斯拉车辆数据记录器，使用 Elixir 编写，数据存储在 PostgreSQL 数据库中，并通过 Grafana 进行可视化分析。虽然官方推荐使用 Docker 或 NixOS 进行部署，但本指南提供了在非主流系统（包括 Debian、FreeBSD 和 Unraid）上从源码安装的详细步骤。

需要强调的是，这些手动安装方法属于**不受支持（unsupported）**的部署方式。用户应优先考虑使用 Docker 或 NixOS 方案，因为它们提供了更好的隔离性、可重复性和维护性。自行维护源码安装可能面临依赖冲突、版本兼容性问题和安全更新延迟等挑战。

本指南将详细介绍在各个系统上的依赖安装、代码克隆、编译运行、环境配置以及特定的故障排除技巧。

**Section sources**
- [README.md](file://README.md#L1-L88)

## 系统要求

在开始安装之前，确保目标系统满足以下核心依赖的最低版本要求：

- **Elixir**: v1.16+
- **Erlang**: v25+ (通常随 Elixir 一起安装)
- **PostgreSQL**: v16.7+, v17.3+ 或 v18.0+
- **Grafana**: v12.0.1+
- **MQTT Broker**: 如 Mosquitto
- **Node.js**: v20+
- **npm**: 用于前端资源构建

这些组件共同构成了 TeslaMate 的运行环境。PostgreSQL 用于持久化存储车辆数据，Grafana 用于数据可视化，MQTT Broker 用于实时消息传递，而 Node.js 和 npm 则用于编译前端静态资源。

**Section sources**
- [debian.md](file://website/docs/installation/unsupported/debian.md#L8-L107)
- [freebsd.md](file://website/docs/installation/unsupported/freebsd.md#L9-L102)

## Debian/Ubuntu 安装指南

### 依赖安装

在 Debian 或 Ubuntu 系统上，可以通过 APT 包管理器安装所需的依赖。以下是推荐的安装命令：

```bash
# 安装 PostgreSQL
wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
echo "deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main" | sudo tee /etc/apt/sources.list.d/pgdg.list
sudo apt-get update
sudo apt-get install -y postgresql-18 postgresql-client-18

# 安装 Elixir 和 Erlang
wget https://packages.erlang-solutions.com/erlang-solutions_2.0_all.deb && sudo dpkg -i erlang-solutions_2.0_all.deb
sudo apt-get update
sudo apt-get install -y elixir esl-erlang

# 安装 Grafana
sudo apt-get install -y apt-transport-https software-properties-common
sudo add-apt-repository "deb https://packages.grafana.com/oss/deb stable main"
wget -q -O - https://packages.grafana.com/gpg.key | sudo apt-key add -
sudo apt-get update
sudo apt-get install -y grafana
sudo systemctl start grafana-server
sudo systemctl enable grafana-server.service

# 安装 Mosquitto MQTT Broker
sudo apt-get install -y mosquitto

# 安装 Node.js
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo bash -
sudo apt-get install -y nodejs
```

### 代码克隆与编译

完成依赖安装后，克隆 TeslaMate 源码并进行编译：

```bash
# 克隆代码库
cd /usr/src
git clone https://github.com/teslamate-org/teslamate.git
cd teslamate
git checkout $(git describe --tags `git rev-list --tags --max-count=1`)

# 安装 Elixir 本地工具
mix local.hex --force; mix local.rebar --force

# 获取项目依赖并编译前端资源
mix deps.get --only prod
npm install --prefix ./assets && npm run deploy --prefix ./assets

# 构建生产环境发布包
MIX_ENV=prod mix do phx.digest, release --overwrite
```

### 数据库配置

创建 TeslaMate 专用的 PostgreSQL 数据库和用户：

```bash
sudo -u postgres psql
postgres=# create database teslamate;
postgres=# create user teslamate with encrypted password 'your_secure_password_here';
postgres=# grant all privileges on database teslamate to teslamate;
postgres=# ALTER USER teslamate WITH SUPERUSER;
postgres=# \q
```

### 系统服务配置

创建 systemd 服务文件 `/etc/systemd/system/teslamate.service` 以实现开机自启：

```ini
[Unit]
Description=TeslaMate
After=network.target
After=postgresql.service

[Service]
Type=simple
Restart=on-failure
RestartSec=5

Environment="HOME=/usr/src/teslamate"
Environment="LANG=en_US.UTF-8"
Environment="LC_CTYPE=en_US.UTF-8"
Environment="TZ=Europe/Berlin"
Environment="PORT=4000"
Environment="ENCRYPTION_KEY=your_secure_encryption_key_here"
Environment="DATABASE_USER=teslamate"
Environment="DATABASE_PASS=your_secure_password_here"
Environment="DATABASE_NAME=teslamate"
Environment="DATABASE_HOST=127.0.0.1"
Environment="MQTT_HOST=127.0.0.1"

WorkingDirectory=/usr/src/teslamate
ExecStartPre=/usr/src/teslamate/_build/prod/rel/teslamate/bin/teslamate eval "TeslaMate.Release.migrate"
ExecStart=/usr/src/teslamate/_build/prod/rel/teslamate/bin/teslamate start
ExecStop=/usr/src/teslamate/_build/prod/rel/teslamate/bin/teslamate stop

[Install]
WantedBy=multi-user.target
```

启动并启用服务：
```bash
sudo systemctl start teslamate
sudo systemctl enable teslamate
```

**Section sources**
- [debian.md](file://website/docs/installation/unsupported/debian.md#L107-L270)

## FreeBSD 安装指南

### 依赖安装

在 FreeBSD 系统（或 jail）中，使用 `pkg` 命令安装依赖：

```bash
# 安装基础工具
pkg install bash jq git

# 安装 Elixir 和 Erlang
pkg install erlang elixir

# 安装 PostgreSQL
pkg install postgresql18-server postgresql18-contrib
echo postgres_enable="yes" >> /etc/rc.conf

# 初始化数据库
service postgresql initdb

# 安装 Grafana
pkg install grafana
echo grafana_enable="yes" >> /etc/rc.conf

# 安装 Mosquitto
pkg install mosquitto
echo mosquitto_enable="yes" >> /etc/rc.conf

# 安装 Node.js
pkg install node20 npm-node20
```

### 代码克隆与编译

克隆源码并编译项目：

```bash
# 克隆代码库
cd /usr/local/src
git clone https://github.com/teslamate-org/teslamate.git
cd teslamate
git checkout $(git describe --tags `git rev-list --tags --max-count=1`)

# 安装 Elixir 本地工具
mix local.hex --force; mix local.rebar --force

# 获取依赖并编译前端
mix deps.get --only prod
npm install --prefix ./assets && npm run deploy --prefix ./assets

# 构建生产环境发布包
export MIX_ENV=prod
mix do phx.digest, release --overwrite
```

### FreeBSD 服务配置

创建 FreeBSD 服务脚本 `/usr/local/etc/rc.d/teslamate`：

```bash
#!/bin/sh
# PROVIDE: teslamate
# REQUIRE: DAEMON
# KEYWORD: teslamate,tesla

. /etc/rc.subr

name=teslamate
rcvar=teslamate_enable

load_rc_config $name

user=teslamate
group=teslamate

teslamate_enable=${teslamate_enable-"NO"}
pidfile=${teslamate_pidfile-"/var/run/${name}.pid"}

teslamate_enable_mqtt=${teslamate_enable_mqtt-"FALSE"}
teslamate_db_port=${teslamate_db_port-"5432"}

HTTP_BINDING_ADDRESS="0.0.0.0"; export HTTP_BINDING_ADDRESS
HOME="/usr/local/src/teslamate"; export HOME
PORT=${teslamate_port-"4000"}; export PORT
TZ=${teslamate_timezone-"Europe/Berlin"}; export TZ
LANG=${teslamate_locale-"en_US.UTF-8"}; export LANG
LC_CTYPE=${teslamate_locale-"en_US.UTF-8"}; export LC_TYPE
DATABASE_NAME=${teslamate_db-"teslamate"}; export DATABASE_NAME
DATABASE_HOST=${teslamate_db_host-"localhost"}; export DATABASE_HOST
DATABASE_USER=${teslamate_db_user-"teslamate"}; export DATABASE_USER
DATABASE_PASS=${teslamate_db_pass}; export DATABASE_PASS
ENCRYPTION_KEY=${teslamate_encryption_key}; export ENCRYPTION_KEY
DISABLE_MQTT=${teslamate_mqtt_enable-"FALSE"}; export DISABLE_MQTT
MQTT_HOST=${teslamate_mqtt_host-"localhost"}; export MQTT_HOST

COMMAND=${teslamate_command-"${HOME}/_build/prod/rel/teslamate/bin/teslamate"}

teslamate_start()
{
  ${COMMAND} eval "TeslaMate.Release.migrate"
  ${COMMAND} daemon
}

start_cmd="${name}_start"
stop_cmd="${COMMAND} stop"
status_cmd="${COMMAND} pid"

run_rc_command "$1"
```

在 `/etc/rc.conf` 中添加配置：
```bash
echo teslamate_enable="YES" >> /etc/rc.conf
echo teslamate_db_host="localhost" >> /etc/rc.conf
echo teslamate_db_pass="<super secret>" >> /etc/rc.conf
echo teslamate_encryption_key="<super secret encryption key>" >> /etc/rc.conf
echo teslamate_timezone="Europe/Berlin" >> /etc/rc.conf
```

启动服务：
```bash
chmod +x /usr/local/etc/rc.d/teslamate
service teslamate start
```

**Section sources**
- [freebsd.md](file://website/docs/installation/unsupported/freebsd.md#L102-L224)

## Unraid 安装指南

### 使用社区应用模板

在 Unraid 上，可以通过社区应用（Community Apps）商店安装各个组件：

1. **PostgreSQL**: 搜索 `postgresql17` 并安装，设置 `POSTGRES_USER` 为 `teslamate`，`POSTGRES_DB` 为 `teslamate`。
2. **Mosquitto**: 搜索 `mosquitto` 并安装。
3. **TeslaMate**: 搜索 `TeslaMate` 并安装，配置数据库和 MQTT 连接信息。
4. **TeslaMate-Grafana**: 搜索 `TeslaMate Grafana` 并安装，配置数据源。

### 手动容器创建

也可以手动创建 Docker 容器，使用以下环境变量进行配置：

- `ENCRYPTION_KEY`: 用于加密 Tesla API 令牌的密钥。
- `DATABASE_USER`, `DATABASE_PASS`, `DATABASE_NAME`, `DATABASE_HOST`: 数据库连接信息。
- `MQTT_HOST`: MQTT 代理的 IP 地址。

### 备份与恢复

使用 Unraid 的用户脚本（User Scripts）插件创建备份脚本：

```bash
#!/bin/bash
BACKUP_DIR="/mnt/user/backups/SQL/postgres17"
databases=`docker exec postgresql17 psql -U teslamate teslamate -l -t | cut -d'|' -f1 | sed -e 's/ //g' -e '/^$/d'`
for db in $databases; do
  if [ "$db" != "postgres" ] && [ "$db" != "template0" ] && [ "$db" != "template1" ]; then
    FOLDER=$BACKUP_DIR/$db
    mkdir -p "$FOLDER"
    FILENAME=${db}_$(date +%A).sql
    FILEPATH=$FOLDER/$FILENAME
    docker exec postgresql17 pg_dump --clean -h 127.0.0.1 -U teslamate -d $db > $FILEPATH
    tar czf $FILEPATH.tgz -C $FOLDER $FILENAME
    rm $FILEPATH
  fi
done
find $BACKUP_DIR/ -type f -name '*.tgz' -mtime +7 -exec rm {} \;
```

**Section sources**
- [unraid.md](file://website/docs/installation/unsupported/unraid.md#L18-L233)

## 通用构建流程

无论在哪个系统上，从源码构建 TeslaMate 的核心流程是相同的：

1. **获取依赖**: `mix deps.get --only prod`
2. **编译前端资源**: `npm install --prefix ./assets && npm run deploy --prefix ./assets`
3. **生成静态资源摘要**: `mix phx.digest`
4. **构建发布包**: `mix release --overwrite`

`npm run deploy` 命令会调用 `esbuild` 工具链，将 JavaScript 和 CSS 资源进行打包、压缩和优化，输出到 `priv/static/assets` 目录。`mix phx.digest` 会为这些静态文件生成唯一的哈希值，用于浏览器缓存控制。

**Section sources**
- [mix.exs](file://mix.exs#L78-L84)
- [package.json](file://assets/package.json#L6)
- [build.js](file://assets/scripts/build.js#L1-L73)

## 环境变量配置

TeslaMate 通过环境变量进行配置。关键的环境变量包括：

- **ENCRYPTION_KEY**: 加密 Tesla API 令牌的密钥，必须设置。
- **DATABASE_***: 数据库连接参数（用户、密码、主机、端口、数据库名）。
- **MQTT_HOST**: MQTT 代理的主机地址。
- **TZ**: 系统时区，如 `Europe/Berlin`。
- **PORT**: Web 服务监听端口，默认为 4000。

这些变量可以在系统环境、服务文件或 Docker 容器中设置。`runtime.exs` 配置文件负责读取这些环境变量并应用到应用程序中。

**Section sources**
- [runtime.exs](file://config/runtime.exs#L101-L190)
- [environment_variables.md](file://website/docs/configuration/environment_variables.md#L9-L62)

## 故障排除

### Erlang 版本兼容性

确保安装的 Erlang 版本与 Elixir 兼容。使用 `erl -version` 和 `elixir --version` 检查版本。如果出现编译错误，尝试更新或重新安装 Erlang/Elixir。

### 文件权限

在 FreeBSD 或某些 Linux 发行版上，确保运行 TeslaMate 的用户对代码目录和数据目录有适当的读写权限。

### 防火墙设置

确保以下端口在防火墙中是开放的：
- `4000`: TeslaMate Web 界面
- `3000`: Grafana Web 界面
- `5432`: PostgreSQL 数据库
- `1883`: MQTT 代理（非 TLS）

### 数据库连接问题

如果 TeslaMate 无法连接到 PostgreSQL，检查：
- 数据库服务是否正在运行
- `DATABASE_HOST` 和 `DATABASE_PORT` 是否正确
- 用户名和密码是否匹配
- PostgreSQL 的 `pg_hba.conf` 文件是否允许来自 TeslaMate 主机的连接

**Section sources**
- [debian.md](file://website/docs/installation/unsupported/debian.md#L120-L131)
- [freebsd.md](file://website/docs/installation/unsupported/freebsd.md#L115-L126)
- [entrypoint.sh](file://entrypoint.sh#L14-L18)

## 维护与更新

手动安装的 TeslaMate 需要用户自行负责更新。更新流程通常包括：
1. 停止当前服务
2. 拉取最新的代码 `git pull`
3. 检出最新稳定版本 `git checkout $(git describe --tags --abbrev=0)`
4. 重新运行构建流程
5. 启动服务

在更新前，务必查看 [发布说明](https://github.com/teslamate-org/teslamate/releases) 以了解可能的破坏性变更。建议在更新前备份数据库。

**Section sources**
- [unraid.md](file://website/docs/installation/unsupported/unraid.md#L63-L66)
- [Makefile](file://Makefile#L13-L20)
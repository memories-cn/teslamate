# 充电成本跟踪

<cite>
**本文档引用的文件**   
- [charge.ex](file://lib/teslamate/log/charge.ex)
- [charging_process.ex](file://lib/teslamate/log/charging_process.ex)
- [cost.ex](file://lib/teslamate_web/live/charge_live/cost.ex)
- [cost.html.heex](file://lib/teslamate_web/live/charge_live/cost.html.heex)
- [locations.ex](file://lib/teslamate/locations.ex)
- [settings.ex](file://lib/teslamate/settings.ex)
- [20191117042320_add_cost_field_to_charges.exs](file://priv/repo/migrations/20191117042320_add_cost_field_to_charges.exs)
- [20200203180529_location_based_charge_cost.exs](file://priv/repo/migrations/20200203180529_location_based_charge_cost.exs)
- [20200212001245_location_based_charge_cost_increase_scale.exs](file://priv/repo/migrations/20200212001245_location_based_charge_cost_increase_scale.exs)
- [20200528163852_cost_by_minute.exs](file://priv/repo/migrations/20200528163852_cost_by_minute.exs)
- [20200306133847_add_flat_fee.exs](file://priv/repo/migrations/20200306133847_add_flat_fee.exs)
</cite>

## 目录
1. [引言](#引言)
2. [核心数据模型](#核心数据模型)
3. [成本计算规则](#成本计算规则)
4. [成本计算与充电会话集成](#成本计算与充电会话集成)
5. [Grafana仪表板中的成本分析](#grafana仪表板中的成本分析)
6. [自定义电价配置与特殊计费场景](#自定义电价配置与特殊计费场景)
7. [结论](#结论)

## 引言
本文档全面介绍TeslaMate系统中充电成本跟踪的实现机制。重点阐述了充电成本的计算、记录和分析流程，包括Charge数据模型中cost字段的设计、基于地理位置的电价应用、超级充电站免费充电识别逻辑，以及成本计算与充电会话更新的集成方式。同时，结合Grafana仪表板的SQL查询，展示如何进行多维度的成本统计分析。

## 核心数据模型

充电成本跟踪的核心数据模型围绕充电会话（Charging Process）展开。系统通过`charging_processes`数据库表记录每次充电的详细信息，其中`cost`字段是成本计算的核心。

`cost`字段最初在2019年11月通过迁移文件`20191117042320_add_cost_field_to_charges.exs`添加到`charging_processes`表中，数据类型为`:decimal`，精度为6，小数位数为2。随后，为了支持更精确的电价计算，该字段的精度在`20200212001245_location_based_charge_cost_increase_scale.exs`迁移中被调整为小数位数4。

除了`charging_processes`表，`geofences`表（地理围栏）也扮演着关键角色。它通过`cost_per_unit`字段存储单位电价，并通过`billing_type`枚举字段区分按千瓦时（per_kwh）或按分钟（per_minute）计费。此外，`session_fee`字段用于记录会话费（即起步价或固定费用）。`car_settings`表则包含`free_supercharging`布尔字段，用于标识车辆是否享有免费超级充电特权。

**Section sources**
- [20191117042320_add_cost_field_to_charges.exs](file://priv/repo/migrations/20191117042320_add_cost_field_to_charges.exs#L1-L9)
- [20200203180529_location_based_charge_cost.exs](file://priv/repo/migrations/20200203180529_location_based_charge_cost.exs#L1-L13)
- [20200212001245_location_based_charge_cost_increase_scale.exs](file://priv/repo/migrations/20200212001245_location_based_charge_cost_increase_scale.exs#L1-L15)
- [20200528163852_cost_by_minute.exs](file://priv/repo/migrations/20200528163852_cost_by_minute.exs#L1-L23)
- [20200306133847_add_flat_fee.exs](file://priv/repo/migrations/20200306133847_add_flat_fee.exs#L1-L9)
- [charging_process.ex](file://lib/teslamate/log/charging_process.ex#L1-L60)

## 成本计算规则

充电成本的计算遵循一套基于地理位置和车辆设置的综合规则。

首先，系统通过地理位置确定计费策略。当车辆在某个地理围栏（GeoFence）内充电时，系统会应用该围栏配置的计费规则。计费类型由`billing_type`字段决定，支持两种模式：
1.  **按千瓦时计费 (per_kwh)**：总成本 = 会话费 + (单位电价 × 充入电量)。系统会取`charge_energy_added`和`charge_energy_used`两个值中的较大者作为计算依据。
2.  **按分钟计费 (per_minute)**：总成本 = 会话费 + (单位电价 × 充电时长)。

其次，系统会检查车辆的特殊设置。如果`car_settings`中的`free_supercharging`字段被设置为`true`，则无论地理位置如何，本次充电的成本将被强制设置为零，以实现对享有免费超级充电权益车辆的支持。

这些规则在`lib/teslamate/log.ex`文件的`calculate_cost/2`函数中实现，该函数通过模式匹配处理不同的计费场景，并利用`Decimal`库进行精确的浮点数运算，避免了精度损失。

**Section sources**
- [locations.ex](file://lib/teslamate/locations.ex#L231-L254)
- [log.ex](file://lib/teslamate/log.ex#L591-L632)
- [20200528163852_cost_by_minute.exs](file://priv/repo/migrations/20200528163852_cost_by_minute.exs#L1-L23)
- [20200306133847_add_flat_fee.exs](file://priv/repo/migrations/20200306133847_add_flat_fee.exs#L1-L9)
- [settings_test.exs](file://test/teslamate/settings_test.exs#L121-L160)

## 成本计算与充电会话集成

成本计算与充电会话的更新紧密集成，主要通过用户界面和后台逻辑协同完成。

用户可以通过`/charge-cost/{id}`页面手动为已完成的充电会话添加成本。该页面由`TeslaMateWeb.ChargeLive.Cost` LiveView模块驱动。用户可以选择输入总成本、按每千瓦时单价或按每分钟单价来计算。当用户提交表单时，`handle_event("save", ...)`函数会被触发。

该函数首先根据用户选择的模式进行计算：
- 如果选择“按每千瓦时”，则将输入的单价乘以本次充电的电量（取`charge_energy_added`和`charge_energy_used`的最大值）。
- 如果选择“按每分钟”，则将输入的单价乘以本次充电的时长（`duration_min`）。

计算出的总成本随后被更新到`charging_process`记录中，通过调用`Log.update_charging_process/2`函数完成持久化。此外，系统还支持批量计算。当用户在地理围栏设置中修改了电价后，系统会弹出一个模态框，询问是否为该围栏内所有未计算成本的充电会话批量应用新的计费规则。这一功能通过`Locations.calculate_charge_costs/1`函数实现，该函数执行一条SQL `UPDATE`语句，高效地为符合条件的会话计算并填充成本。

**Section sources**
- [cost.ex](file://lib/teslamate_web/live/charge_live/cost.ex#L1-L127)
- [cost.html.heex](file://lib/teslamate_web/live/charge_live/cost.html.heex#L1-L180)
- [locations.ex](file://lib/teslamate/locations.ex#L231-L254)
- [charge_cost_live_test.exs](file://test/teslamate_web/live/charge_cost_live_test.exs#L266-L343)

## Grafana仪表板中的成本分析

Grafana仪表板利用SQL查询对充电成本进行多维度的统计分析。`grafana/dashboards/charging-stats.json`等仪表板文件中定义了相关的查询。

典型的成本分析查询会从`charging_processes`表中提取数据，并按以下维度进行分组和聚合：
- **按地理位置**：通过`JOIN` `geofences`表，按`geofence.name`分组，计算每个地点的总成本、平均成本和充电次数。
- **按时间段**：使用`date_trunc`函数（如`date_trunc('month', start_date)`）将`start_date`按月、周或日进行分组，以分析成本随时间的变化趋势。
- **按充电类型**：通过`fast_charger_present`字段或`geofence`的名称来区分家用充电、目的地充电和超级充电，并分别统计其成本。

这些查询将`cost`字段作为核心的聚合对象，使用`SUM(cost)`计算总支出，`AVG(cost)`计算平均单次充电成本。通过将这些数据可视化为柱状图、折线图和饼图，用户可以直观地了解充电费用的分布和趋势。

**Section sources**
- [charging-stats.json](file://grafana/dashboards/charging-stats.json)
- [locations.json](file://grafana/dashboards/locations.json)
- [charges.json](file://grafana/dashboards/charges.json)

## 自定义电价配置与特殊计费场景

系统提供了灵活的机制来配置自定义电价和处理特殊计费场景。

用户可以在“地理围栏”设置中为每个地点配置详细的计费信息。这包括设置`cost_per_unit`（单位电价）、`billing_type`（计费模式）和`session_fee`（会话费）。例如，可以为家中的充电桩设置一个较低的按千瓦时电价，同时为某些公共充电站配置较高的按分钟计费模式和额外的会话费。

对于特殊场景，系统提供了以下支持：
- **免费充电**：通过在车辆设置中启用“免费超级充电”选项，可以将特定车辆在任何地点的充电成本归零。
- **负电价**：系统允许`cost_per_unit`为负值，这可以用于模拟政府补贴或返现等场景。
- **零费用**：所有费用（单位电价和会话费）均可设置为零，以表示完全免费的充电站。

这些配置确保了系统能够适应全球各地复杂多变的充电定价策略。

**Section sources**
- [form.html.heex](file://lib/teslamate_web/live/geofence_live/form.html.heex#L138-L181)
- [index.html.heex](file://lib/teslamate_web/live/settings_live/index.html.heex#L120-L156)
- [log_charging_test.exs](file://test/teslamate/log/log_charging_test.exs#L394-L609)

## 结论
TeslaMate的充电成本跟踪系统通过精心设计的数据模型和灵活的计算规则，实现了对电动汽车充电费用的精确记录和分析。系统将地理位置、车辆设置和用户输入有机结合，支持多种计费模式和特殊场景。通过与Grafana的深度集成，用户可以获得丰富的成本洞察，从而更好地管理和优化充电支出。
# 能效分析模型

<cite>
**本文档引用文件**   
- [efficiency.json](file://grafana/dashboards/efficiency.json)
- [convert.ex](file://lib/teslamate/convert.ex)
- [terrain.ex](file://lib/teslamate/terrain.ex)
- [log.ex](file://lib/teslamate/log.ex)
- [settings.ex](file://lib/teslamate/settings.ex)
</cite>

## 目录
1. [引言](#引言)
2. [能效计算模型](#能效计算模型)
3. [单位换算逻辑](#单位换算逻辑)
4. [环境因素对能耗的影响](#环境因素对能耗的影响)
5. [地形数据获取与势能计算](#地形数据获取与势能计算)
6. [自定义能效基准线与警报设置](#自定义能效基准线与警报设置)
7. [能效数据导出与长期趋势分析](#能效数据导出与长期趋势分析)
8. [结论](#结论)

## 引言
TeslaMate系统提供了一套完整的能效分析功能，通过efficiency.json仪表板和相关模块实现对电动汽车能耗的精确计算和分析。本文档详细说明了能效计算模型的核心机制，包括Wh/km、MPGe等单位的换算逻辑，以及温度、地形坡度对能耗的影响系数计算方法。同时介绍了如何利用TeslaMate.Terrain模块获取高程数据并计算势能变化，以及如何自定义能效基准线和设置气候相关能耗偏差警报。

## 能效计算模型
TeslaMate的能效计算模型基于车辆充电过程中的能量消耗与行驶里程之间的关系。系统通过分析充电过程数据来推导车辆的能效因子，该因子以Wh/km或Wh/mi为单位表示。

能效计算的核心SQL查询在efficiency.json文件中定义：
```sql
SELECT
  round((charge_energy_added / NULLIF(end_rated_range_km - start_rated_range_km, 0))::numeric / convert_km(1, '$length_unit'), 3) * 1000 as "efficiency_$length_unit",
  count(*) as count
FROM
  charging_processes
WHERE 
  car_id = $car_id
  AND duration_min > 10
  AND end_battery_level <= 95
  AND start_rated_range_km IS NOT NULL
  AND end_rated_range_km IS NOT NULL
  AND charge_energy_added > 0
GROUP BY
  1
ORDER BY
  2 DESC
LIMIT 3
```

该查询通过以下步骤计算能效：
1. 计算充电过程中增加的电能（charge_energy_added）
2. 计算充电前后额定续航里程的变化
3. 计算单位里程能耗（Wh/km或Wh/mi）
4. 根据出现频率对结果进行排序，选择最可靠的能效值

系统会根据多个充电会话的数据进行统计分析，确保能效因子的准确性。在log.ex文件中，`recalculate_efficiency`函数实现了这一逻辑，通过设置不同的精度和阈值来逐步确定最合适的能效值。

**Section sources**
- [efficiency.json](file://grafana/dashboards/efficiency.json#L1003-L1012)
- [log.ex](file://lib/teslamate/log.ex#L632-L674)

## 单位换算逻辑
TeslaMate系统通过convert.ex模块提供全面的单位转换功能，支持多国单位制的显示和计算。

### 长度单位换算
系统定义了英里与公里之间的换算因子：
- 1英里 = 0.62137119223733公里
- 1公里 = 1.609344英里

在convert.ex文件中，提供了以下函数：
- `miles_to_km/2`：将英里转换为公里
- `km_to_miles/2`：将公里转换为英里
- `mph_to_kmh/1`：将英里/小时转换为公里/小时

### 温度单位换算
系统支持摄氏度与华氏度之间的转换：
- 摄氏度转华氏度：F = C × 9/5 + 32
- 华氏度转摄氏度：C = (F - 32) × 5/9

convert.ex文件中的`celsius_to_fahrenheit/2`函数实现了摄氏度到华氏度的转换，支持指定精度。

### 高程单位换算
系统支持米与英尺之间的转换：
- 1米 = 3.28084英尺
- 1英尺 = 0.3048米

convert.ex文件中的`m_to_ft/1`和`ft_to_m/1`函数分别实现了米到英尺和英尺到米的转换。

这些单位转换函数在系统中被广泛使用，确保用户可以根据个人偏好选择合适的单位制进行数据显示。

**Section sources**
- [convert.ex](file://lib/teslamate/convert.ex#L1-L34)

## 环境因素对能耗的影响
TeslaMate系统考虑了多种环境因素对车辆能耗的影响，其中温度和地形坡度是两个关键因素。

### 温度影响
温度对电动汽车能耗有显著影响。在efficiency.json文件中，有一个专门的表格面板"Temperature – Driving Efficiency"，它按温度区间统计驾驶效率：
```sql
WITH t AS (
  SELECT
    CASE WHEN '$temp_unit' = 'C' THEN ROUND(cast(outside_temp_avg AS numeric) / 5, 0) * 5 
         WHEN '$temp_unit' = 'F' THEN ROUND(cast(convert_celsius(outside_temp_avg, '$temp_unit') AS numeric) / 10, 0) * 10
    END AS outside_temp,
    sum(start_ideal_range_km - end_ideal_range_km) AS total_ideal_range,
    sum(start_rated_range_km - end_rated_range_km) AS total_rated_range,
    sum(distance) AS total_distance,
    sum(duration_min) as duration,
    car_id
  FROM
    drives
  WHERE
    distance IS NOT NULL
    AND car_id = $car_id
    AND convert_km(distance::numeric, '$length_unit') >= $min_distance 
    AND start_${preferred_range}_range_km - end_${preferred_range}_range_km > 0.1
  GROUP BY
    1,
    car_id
)
```

该查询将温度按5°C或10°F的区间进行分组，然后计算每个温度区间的平均能耗。低温环境下，电池效率降低，同时需要额外能量用于车厢加热，导致能耗增加。

### 地形坡度影响
地形坡度对能耗的影响通过势能变化来计算。上坡行驶需要消耗额外能量来克服重力，而下坡行驶则可以通过再生制动回收部分能量。

在drives.json仪表板中，用户可以选择"efficiency"参数为"slope-adjusted"，系统将考虑地形坡度对能耗的影响：
- 上坡：增加能耗，考虑车辆重量和坡度角度
- 下坡：减少能耗，考虑再生制动效率（默认85%）
- 假设车辆重量为2100公斤

这种坡度调整的能效计算方法比简单的距离对比更准确地反映了实际能耗情况。

**Section sources**
- [efficiency.json](file://grafana/dashboards/efficiency.json#L664-L692)
- [drives.json](file://grafana/dashboards/drives.json#L1608-L1624)

## 地形数据获取与势能计算
TeslaMate系统通过TeslaMate.Terrain模块获取高程数据并计算势能变化，为能效分析提供更精确的地形信息。

### 地形模块架构
TeslaMate.Terrain模块是一个基于GenStateMachine的状态机，负责管理高程数据的获取和处理：
- 使用SRTM（Shuttle Radar Topography Mission）数据源获取高程信息
- 通过电路断路器模式（circuit-breaker）处理外部服务调用失败
- 支持异步任务处理，避免阻塞主进程

terrain.ex文件中的`get_elevation/2`函数是获取高程数据的主要接口：
```elixir
def get_elevation(name \\ @name, coordinates) do
  GenStateMachine.call(name, {:get_elevation, coordinates}, 2000)
end
```

### 高程数据获取流程
系统获取高程数据的流程如下：
1. 初始化Terrain状态机，设置超时时间和依赖项
2. 定期查询数据库中缺少高程信息的位置记录
3. 对每个位置坐标调用SRTM服务获取高程数据
4. 将获取的高程数据更新到数据库中

在handle_event回调中，系统处理获取高程数据的请求：
```elixir
def handle_event({:call, from}, {:get_elevation, {lat, lng}}, :ready, %Data{} = data) do
  task = Task.async(fn -> do_get_elevation({lat, lng}, data) end)
  # 处理任务结果，包括成功、失败和超时情况
end
```

### 势能变化计算
虽然代码中没有直接显示势能计算公式，但根据drives.json中的"slope-adjusted"选项描述，可以推断系统使用以下方法计算地形对能耗的影响：
- 上坡能耗增加 = m × g × Δh / η_motor
- 下坡能量回收 = m × g × Δh × η_regenerative
- 其中：m为车辆质量，g为重力加速度，Δh为高度变化，η_motor为电机效率，η_regenerative为再生制动效率

系统假设再生制动效率为85%，车辆重量为2100公斤，通过这些参数计算地形对整体能耗的影响。

**Section sources**
- [terrain.ex](file://lib/teslamate/terrain.ex#L1-L200)
- [drives.json](file://grafana/dashboards/drives.json#L1608-L1624)

## 自定义能效基准线与警报设置
TeslaMate系统允许用户自定义能效基准线并设置气候相关能耗偏差警报，以更好地监控车辆性能变化。

### 能效基准线设置
系统通过全局设置中的preferred_range参数来确定使用哪种续航里程作为能效计算基准：
- :ideal - 理想续航里程
- :rated - 额定续航里程

在settings.ex文件中，当preferred_range设置发生变化时，系统会自动重新计算所有车辆的能效因子：
```elixir
defp on_range_change(%GlobalSettings{}, %GlobalSettings{} = new) do
  Log.recalculate_efficiencies(new)
end
```

用户可以在设置界面选择首选的续航类型，系统会根据选择重新计算能效基准线。

### 气候相关能耗偏差警报
虽然代码中没有直接实现警报功能，但系统提供了足够的数据支持用户创建自定义警报：
1. 通过efficiency.json中的温度-能效关系表，可以识别异常能耗模式
2. 当特定温度区间的能耗显著高于历史平均水平时，可能表示车辆存在问题
3. 用户可以基于这些数据在Grafana中设置阈值警报

例如，如果发现0°C以下的能耗比历史平均值高出20%以上，可能需要检查电池健康状况或热管理系统。

### 单位制设置
用户可以在设置界面选择偏好的单位制：
- 长度单位：公里(km)或英里(mi)
- 温度单位：摄氏度(°C)或华氏度(°F)
- 胎压单位：巴(bar)或磅/平方英寸(psi)

这些设置会影响所有仪表板和报告中的数据显示，确保用户可以使用熟悉的单位进行数据分析。

**Section sources**
- [settings.ex](file://lib/teslamate/settings.ex#L73-L78)
- [index.html.heex](file://lib/teslamate_web/live/settings_live/index.html.heex#L249-L295)

## 能效数据导出与长期趋势分析
TeslaMate系统提供了丰富的能效数据，支持导出用于长期趋势分析。

### 数据导出方法
系统中的能效数据可以通过多种方式导出：
1. **Grafana导出**：在efficiency.json等仪表板中，用户可以直接导出表格数据为CSV格式
2. **数据库查询**：直接访问PostgreSQL数据库，使用SQL查询提取所需数据
3. **API接口**：通过TeslaMate提供的API获取结构化数据

### 长期趋势分析指标
系统提供了多个关键指标用于长期趋势分析：
- 平均净能耗（Ø Consumption (net)）：行驶过程中的实际能耗
- 平均总能耗（Ø Consumption (gross)）：包括充电损耗的总能耗
- 累计行驶距离：所有记录行程的总距离
- 温度-能效关系：不同温度区间的能效表现

在efficiency.json中，这些指标通过不同的SQL查询计算：
```sql
-- 平均净能耗
select 
  sum((start_${preferred_range}_range_km - end_${preferred_range}_range_km) * cars.efficiency) / convert_km(sum(distance)::numeric, '$length_unit') * 1000 AS "consumption_$length_unit"
from drives 
inner join cars on cars.id = car_id
where 
  distance is not null and
  start_${preferred_range}_range_km - end_${preferred_range}_range_km >= 0.1 and
  car_id = $car_id
```

### 趋势分析应用
通过长期跟踪这些指标，用户可以：
1. **评估电池健康状况**：观察能效随时间和里程的变化趋势
2. **优化驾驶习惯**：分析不同驾驶条件下的能耗差异
3. **评估环境影响**：比较不同季节、温度条件下的能耗表现
4. **检测车辆问题**：识别异常的能耗增加，可能预示机械或电气系统问题

这些分析有助于用户更好地理解车辆性能，优化使用策略，并及时发现潜在问题。

**Section sources**
- [efficiency.json](file://grafana/dashboards/efficiency.json#L135-L162)
- [efficiency.json](file://grafana/dashboards/efficiency.json#L247-L274)

## 结论
TeslaMate系统提供了一套完整的能效分析解决方案，通过efficiency.json仪表板和相关模块实现了对电动汽车能耗的精确计算和深入分析。系统不仅考虑了基本的能耗计算，还纳入了温度、地形坡度等环境因素的影响，提供了更准确的能效评估。

核心功能包括：
1. **精确的能效计算模型**：基于充电过程数据推导能效因子
2. **全面的单位转换支持**：通过convert.ex模块支持多国单位制
3. **环境因素影响分析**：考虑温度和地形坡度对能耗的影响
4. **地形数据集成**：通过TeslaMate.Terrain模块获取高程数据
5. **可定制的基准线**：支持用户自定义能效基准和单位设置
6. **长期趋势分析**：提供丰富的数据支持长期性能监控

这些功能共同构成了一个强大的能效分析工具，帮助用户深入了解车辆性能，优化使用策略，并及时发现潜在问题。通过持续监控和分析能效数据，用户可以最大化电动汽车的续航里程和使用效率。
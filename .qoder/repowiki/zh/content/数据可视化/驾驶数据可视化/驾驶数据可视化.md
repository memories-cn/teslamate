# é©¾é©¶æ•°æ®å¯è§†åŒ–

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**   
- [drives.json](file://grafana/dashboards/drives.json)
- [drive-stats.json](file://grafana/dashboards/drive-stats.json)
- [drive-details.json](file://grafana/dashboards/internal/drive-details.json)
- [efficiency.json](file://grafana/dashboards/efficiency.json)
- [timeline.json](file://grafana/dashboards/timeline.json)
- [drive.ex](file://lib/teslamate/log/drive.ex)
- [position.ex](file://lib/teslamate/log/position.ex)
- [car.ex](file://lib/teslamate/log/car.ex)
</cite>

## ç›®å½•
1. [å¼•è¨€](#å¼•è¨€)
2. [è¡Œç¨‹åˆ—è¡¨å­—æ®µè¯´æ˜](#è¡Œç¨‹åˆ—è¡¨å­—æ®µè¯´æ˜)
3. [é©¾é©¶ç»Ÿè®¡æŒ‡æ ‡è®¡ç®—æ–¹æ³•](#é©¾é©¶ç»Ÿè®¡æŒ‡æ ‡è®¡ç®—æ–¹æ³•)
4. [è¯¦ç»†è½¨è¿¹å±•ç¤º](#è¯¦ç»†è½¨è¿¹å±•ç¤º)
5. [èƒ½æ•ˆåˆ†ææ¨¡å‹](#èƒ½æ•ˆåˆ†ææ¨¡å‹)
6. [æ—¶é—´è½´è§†å›¾](#æ—¶é—´è½´è§†å›¾)
7. [EctoæŸ¥è¯¢åˆ°GrafanaæŸ¥è¯¢çš„æ˜ å°„](#ectoæŸ¥è¯¢åˆ°grafanaæŸ¥è¯¢çš„æ˜ å°„)
8. [å¯è§†åŒ–æ ·å¼ä¸è­¦æŠ¥è§„åˆ™è‡ªå®šä¹‰](#å¯è§†åŒ–æ ·å¼ä¸è­¦æŠ¥è§„åˆ™è‡ªå®šä¹‰)

## å¼•è¨€
æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†TeslaMateç³»ç»Ÿä¸­é©¾é©¶ç›¸å…³ä»ªè¡¨æ¿çš„è®¾è®¡ä¸ä½¿ç”¨ã€‚é‡ç‚¹è§£æäº†é©¾é©¶æ•°æ®çš„å¯è§†åŒ–ç»„ä»¶ï¼ŒåŒ…æ‹¬è¡Œç¨‹åˆ—è¡¨ã€é©¾é©¶ç»Ÿè®¡ã€è¯¦ç»†è½¨è¿¹ã€èƒ½æ•ˆåˆ†æå’Œæ—¶é—´è½´è§†å›¾ã€‚æ–‡æ¡£è¿˜è¯´æ˜äº†å¦‚ä½•å°†EctoæŸ¥è¯¢æ˜ å°„åˆ°GrafanaæŸ¥è¯¢ï¼Œå¹¶æä¾›äº†è‡ªå®šä¹‰å¯è§†åŒ–æ ·å¼å’Œè­¦æŠ¥è§„åˆ™çš„æ–¹æ³•ã€‚

## è¡Œç¨‹åˆ—è¡¨å­—æ®µè¯´æ˜
`drives.json`ä»ªè¡¨æ¿ä¸­çš„è¡Œç¨‹åˆ—è¡¨å±•ç¤ºäº†æ‰€æœ‰é©¾é©¶è¡Œç¨‹çš„å…³é”®ä¿¡æ¯ã€‚ä»¥ä¸‹æ˜¯ä¸»è¦å­—æ®µçš„å«ä¹‰ï¼š

- **start_date**: é©¾é©¶å¼€å§‹æ—¶é—´
- **end_date**: é©¾é©¶ç»“æŸæ—¶é—´  
- **distance_km/distance_mi**: é©¾é©¶è·ç¦»ï¼ˆå…¬é‡Œ/è‹±é‡Œï¼‰
- **consumption_kWh**: å‡€èƒ½è€—ï¼ˆåƒç“¦æ—¶ï¼‰
- **consumption_kwh_km/consumption_kwh_mi**: å¹³å‡èƒ½è€—ï¼ˆç“¦æ—¶/å…¬é‡Œæˆ–ç“¦æ—¶/è‹±é‡Œï¼‰
- **duration_min**: é©¾é©¶æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
- **outside_temp_c**: å¹³å‡å¤–éƒ¨æ¸©åº¦ï¼ˆæ‘„æ°åº¦ï¼‰
- **start_address**: èµ·å§‹åœ°å€
- **end_address**: ç›®çš„åœ°åœ°å€
- **start_ideal_range_km/end_ideal_range_km**: å¼€å§‹/ç»“æŸæ—¶çš„ç†æƒ³ç»­èˆªé‡Œç¨‹
- **start_rated_range_km/end_rated_range_km**: å¼€å§‹/ç»“æŸæ—¶çš„é¢å®šç»­èˆªé‡Œç¨‹
- **speed_max**: æœ€é«˜é€Ÿåº¦

è¿™äº›å­—æ®µæ¥æºäºæ•°æ®åº“ä¸­çš„`drives`è¡¨ï¼Œé€šè¿‡Ectoæ¨¡å‹`TeslaMate.Log.Drive`å®šä¹‰ï¼ŒåŒ…å«äº†é©¾é©¶çš„åŸºæœ¬ä¿¡æ¯å’Œæ€§èƒ½æŒ‡æ ‡ã€‚

**Section sources**
- [drives.json](file://grafana/dashboards/drives.json)
- [drive.ex](file://lib/teslamate/log/drive.ex)

## é©¾é©¶ç»Ÿè®¡æŒ‡æ ‡è®¡ç®—æ–¹æ³•
`drive-stats.json`ä»ªè¡¨æ¿æä¾›äº†é©¾é©¶æ•°æ®çš„ç»Ÿè®¡åˆ†æã€‚å…¶æ ¸å¿ƒæŒ‡æ ‡çš„è®¡ç®—æ–¹æ³•å¦‚ä¸‹ï¼š

### é©¾é©¶æ¬¡æ•°ç»Ÿè®¡
é€šè¿‡ä»¥ä¸‹SQLæŸ¥è¯¢è®¡ç®—æŒ‡å®šæ—¶é—´æ®µå†…çš„é©¾é©¶æ¬¡æ•°ï¼š
```sql
SELECT date_trunc('day', timezone('UTC', start_date), '$__timezone') AS date,
       count(*) AS number_of_drives
FROM drives
WHERE car_id = $car_id and $__timeFilter(start_date) and end_date is not null
GROUP BY 1
```

### æ€»è¡Œé©¶è·ç¦»
è®¡ç®—æ€»è¡Œé©¶è·ç¦»çš„æŸ¥è¯¢ï¼š
```sql
SELECT convert_km(sum(distance), '$length_unit') as "distance_$length_unit"
FROM drives
WHERE car_id = $car_id and $__timeFilter(start_date) and end_date is not null
```

### å¹³å‡èƒ½è€—
å¹³å‡èƒ½è€—çš„è®¡ç®—åŸºäºç»­èˆªé‡Œç¨‹å˜åŒ–å’Œè½¦è¾†æ•ˆç‡ï¼š
```sql
SELECT sum((start_${preferred_range}_range_km - end_${preferred_range}_range_km) * cars.efficiency) AS energy
FROM drives INNER JOIN cars on drives.car_id = cars.id
WHERE car_id = $car_id and $__timeFilter(start_date) and end_date is not null
```

### ä¸­ä½æ•°é©¾é©¶è·ç¦»
ä½¿ç”¨ç™¾åˆ†ä½å‡½æ•°è®¡ç®—ä¸­ä½æ•°é©¾é©¶è·ç¦»ï¼š
```sql
SELECT convert_km((percentile_cont(0.5) WITHIN GROUP (ORDER BY distance))::numeric, '$length_unit') 
FROM drives 
WHERE car_id = $car_id AND $__timeFilter(start_date) AND end_date IS NOT NULL
```

è¿™äº›ç»Ÿè®¡æŒ‡æ ‡é€šè¿‡Grafanaçš„æ—¶é—´åºåˆ—å’Œè¡¨æ ¼é¢æ¿å±•ç¤ºï¼Œä¸ºç”¨æˆ·æä¾›é©¾é©¶è¡Œä¸ºçš„å®è§‚è§†å›¾ã€‚

**Section sources**
- [drive-stats.json](file://grafana/dashboards/drive-stats.json)

## è¯¦ç»†è½¨è¿¹å±•ç¤º
`drive-details.json`ä»ªè¡¨æ¿æä¾›äº†å•æ¬¡é©¾é©¶çš„è¯¦ç»†è½¨è¿¹å±•ç¤ºï¼ŒåŒ…å«å¤šä¸ªå…³é”®ç»„ä»¶ï¼š

### é©¾é©¶æ•°æ®æ—¶åºå›¾
è¯¥å›¾è¡¨å±•ç¤ºäº†é©¾é©¶è¿‡ç¨‹ä¸­çš„å…³é”®å‚æ•°éšæ—¶é—´çš„å˜åŒ–ï¼š
- **é€Ÿåº¦**: å®æ—¶é€Ÿåº¦æ›²çº¿
- **åŠŸç‡**: åŠ¨åŠ›è¾“å‡ºï¼ˆæ­£å€¼ä¸ºåŠ é€Ÿï¼Œè´Ÿå€¼ä¸ºå›æ”¶ï¼‰
- **ç”µæ± ç”µé‡**: SOCï¼ˆState of Chargeï¼‰å˜åŒ–
- **å¯ç”¨ç”µæ± ç”µé‡**: å¯ç”¨SOCå˜åŒ–
- **ç»­èˆªé‡Œç¨‹**: ç†æƒ³ã€é¢å®šå’Œé¢„ä¼°ç»­èˆªé‡Œç¨‹
- **ç”µæ± åŠ çƒ­å™¨**: ç”µæ± åŠ çƒ­çŠ¶æ€

### åœ°ç†ä½ç½®è½¨è¿¹å›¾
é€šè¿‡geomapç»„ä»¶å±•ç¤ºé©¾é©¶çš„åœ°ç†è½¨è¿¹ï¼š
```sql
SELECT latitude, longitude FROM positions 
WHERE car_id = $car_id AND $__timeFilter(date) 
ORDER BY date ASC
```

### è½¨è¿¹è¯¦æƒ…
è¯¦ç»†è½¨è¿¹åŒ…æ‹¬ï¼š
- **æµ·æ‹”å˜åŒ–**: å±•ç¤ºé©¾é©¶è¿‡ç¨‹ä¸­çš„æµ·æ‹”å˜åŒ–
- **é©¾é©¶è¯¦æƒ…**: èµ·å§‹å’Œç»“æŸä½ç½®ã€å……ç”µä¿¡æ¯ç­‰
- **ç¯å¢ƒæ•°æ®**: å¤–éƒ¨æ¸©åº¦ã€å†…éƒ¨æ¸©åº¦ç­‰

è¯¥ä»ªè¡¨æ¿é€šè¿‡å°†`positions`è¡¨ä¸­çš„ä½ç½®æ•°æ®ä¸é©¾é©¶æ•°æ®å…³è”ï¼Œå®ç°äº†è¯¦ç»†çš„è½¨è¿¹å¯è§†åŒ–ã€‚

**Section sources**
- [drive-details.json](file://grafana/dashboards/internal/drive-details.json)
- [position.ex](file://lib/teslamate/log/position.ex)

## èƒ½æ•ˆåˆ†ææ¨¡å‹
`efficiency.json`ä»ªè¡¨æ¿ä¸“æ³¨äºé©¾é©¶èƒ½æ•ˆçš„åˆ†æï¼Œå…¶æ ¸å¿ƒæ¨¡å‹åŒ…æ‹¬ï¼š

### å‡€èƒ½è€—è®¡ç®—
å‡€èƒ½è€—åŸºäºç»­èˆªé‡Œç¨‹å˜åŒ–è®¡ç®—ï¼š
```sql
SELECT sum((start_${preferred_range}_range_km - end_${preferred_range}_range_km) * cars.efficiency) / convert_km(sum(distance)::numeric, '$length_unit') * 1000
FROM drives inner join cars on cars.id = car_id
```

### æ€»èƒ½è€—è®¡ç®—
æ€»èƒ½è€—è€ƒè™‘äº†å……ç”µè¿‡ç¨‹ä¸­çš„èƒ½é‡æŸå¤±ï¼š
```sql
WITH d1 AS (
  SELECT lag(end_${preferred_range}_range_km) OVER (ORDER BY start_date) - start_${preferred_range}_range_km AS range_loss,
         p.odometer - lag(p.odometer) OVER (ORDER BY start_date) AS distance
  FROM charging_processes c LEFT JOIN positions p ON p.id = c.position_id
)
SELECT range_loss * c.efficiency / convert_km(distance::numeric, '$length_unit') * 1000
FROM d2 LEFT JOIN cars c ON c.id = car_id
```

### æ¸©åº¦ä¸èƒ½æ•ˆå…³ç³»
åˆ†æä¸åŒæ¸©åº¦ä¸‹çš„é©¾é©¶æ•ˆç‡ï¼š
```sql
SELECT outside_temp, total_distance / total_${preferred_range}_range AS efficiency
FROM t JOIN cars c ON t.car_id = c.id
```

è¯¥æ¨¡å‹é€šè¿‡æ¸©åº¦åˆ†ç»„åˆ†æï¼Œæ­ç¤ºäº†ç¯å¢ƒæ¸©åº¦å¯¹ç”µåŠ¨æ±½è½¦èƒ½æ•ˆçš„å½±å“è§„å¾‹ã€‚

**Section sources**
- [efficiency.json](file://grafana/dashboards/efficiency.json)

## æ—¶é—´è½´è§†å›¾
`timeline.json`ä»ªè¡¨æ¿æä¾›äº†å…¨é¢çš„æ—¶é—´è½´è§†å›¾ï¼Œæ•´åˆäº†é©¾é©¶ã€å……ç”µã€åœè½¦ç­‰å¤šç§æ´»åŠ¨ï¼š

### æ´»åŠ¨ç±»å‹
æ—¶é—´è½´åŒ…å«ä»¥ä¸‹æ´»åŠ¨ç±»å‹ï¼š
- **ğŸš— é©¾é©¶**: é©¾é©¶è¡Œç¨‹
- **ğŸ”‹ å……ç”µ**: å……ç”µè¿‡ç¨‹
- **ğŸ…¿ï¸ åœè½¦**: åœè½¦æ—¶æ®µ
- **â“ ç¼ºå¤±**: æ•°æ®ç¼ºå¤±æ—¶æ®µ
- **ğŸ’¾ æ›´æ–°**: è½¯ä»¶æ›´æ–°

### æ•°æ®æ•´åˆ
é€šè¿‡CTEï¼ˆå…¬ç”¨è¡¨è¡¨è¾¾å¼ï¼‰æ•´åˆå¤šç§æ´»åŠ¨ï¼š
```sql
with drives_and_charging_processes as (
  select 'Drive' as activity, d.start_date, d.end_date from drives d
  union all
  select 'Charging Process' as activity, cp.start_date, cp.end_date from charging_processes cp
)
```

### åœè½¦æ—¶æ®µè®¡ç®—
ä½¿ç”¨çª—å£å‡½æ•°è®¡ç®—åœè½¦æ—¶æ®µï¼š
```sql
SELECT d.end_date AS "Start", LEAD(d.start_date) over w AS "End"
FROM drives_and_charging_processes AS d
WINDOW w as (ORDER BY d.start_date ASC)
```

æ—¶é—´è½´è§†å›¾ä¸ºç”¨æˆ·æä¾›äº†è½¦è¾†æ´»åŠ¨çš„å®Œæ•´æ—¶é—´çº¿ï¼Œä¾¿äºåˆ†æè½¦è¾†ä½¿ç”¨æ¨¡å¼ã€‚

**Section sources**
- [timeline.json](file://grafana/dashboards/timeline.json)

## EctoæŸ¥è¯¢åˆ°GrafanaæŸ¥è¯¢çš„æ˜ å°„
TeslaMateç³»ç»Ÿé€šè¿‡Ecto ORMä¸æ•°æ®åº“äº¤äº’ï¼Œå…¶æŸ¥è¯¢æ¨¡å¼ä¸GrafanaæŸ¥è¯¢æœ‰ç›´æ¥æ˜ å°„å…³ç³»ï¼š

### Ectoæ¨¡å‹ä¸æ•°æ®åº“è¡¨
- `TeslaMate.Log.Drive` â†” `drives` è¡¨
- `TeslaMate.Log.Position` â†” `positions` è¡¨  
- `TeslaMate.Log.Car` â†” `cars` è¡¨

### æŸ¥è¯¢è½¬æ¢ç¤ºä¾‹
EctoæŸ¥è¯¢ï¼š
```elixir
Position
|> where(car_id: ^id)
|> order_by(desc: :date)
|> limit(1)
|> Repo.one()
```

å¯¹åº”SQLæŸ¥è¯¢ï¼š
```sql
SELECT * FROM positions WHERE car_id = $car_id ORDER BY date DESC LIMIT 1
```

### å¤æ‚æŸ¥è¯¢æ˜ å°„
å¤æ‚çš„EctoæŸ¥è¯¢é€šè¿‡å­æŸ¥è¯¢å’Œè¿æ¥å®ç°ï¼š
```elixir
from(d in Drive,
  where: d.start_date > ^date_earliest,
  select: d.id
)
```

æ˜ å°„åˆ°Grafanaä¸­çš„åŸå§‹SQLæŸ¥è¯¢ï¼Œå®ç°äº†ä»åº”ç”¨å±‚åˆ°å¯è§†åŒ–å±‚çš„æ•°æ®æµåŠ¨ã€‚

**Section sources**
- [drive.ex](file://lib/teslamate/log/drive.ex)
- [position.ex](file://lib/teslamate/log/position.ex)

## è‡ªå®šä¹‰å¯è§†åŒ–æ ·å¼ä¸è­¦æŠ¥è§„åˆ™
ç”¨æˆ·å¯ä»¥æ ¹æ®éœ€æ±‚è‡ªå®šä¹‰é©¾é©¶æ•°æ®çš„å¯è§†åŒ–æ ·å¼å’Œè­¦æŠ¥è§„åˆ™ï¼š

### å¯è§†åŒ–æ ·å¼è‡ªå®šä¹‰
- **é¢œè‰²æ–¹æ¡ˆ**: é€šè¿‡é¢æ¿è®¾ç½®ä¿®æ”¹å›¾è¡¨é¢œè‰²
- **å•ä½è®¾ç½®**: æ”¯æŒå…¬é‡Œ/è‹±é‡Œã€æ‘„æ°åº¦/åæ°åº¦ç­‰å•ä½åˆ‡æ¢
- **å¸ƒå±€è°ƒæ•´**: è‡ªå®šä¹‰é¢æ¿å¤§å°å’Œä½ç½®
- **é˜ˆå€¼è®¾ç½®**: ä¸ºä¸åŒæŒ‡æ ‡è®¾ç½®é¢œè‰²é˜ˆå€¼

### è­¦æŠ¥è§„åˆ™é…ç½®
- **èƒ½è€—è­¦æŠ¥**: å½“èƒ½è€—è¶…è¿‡é˜ˆå€¼æ—¶è§¦å‘
- **é€Ÿåº¦è­¦æŠ¥**: ç›‘æ§è¶…é€Ÿè¡Œä¸º
- **æ¸©åº¦è­¦æŠ¥**: ç”µæ± æ¸©åº¦å¼‚å¸¸æé†’
- **å……ç”µçŠ¶æ€è­¦æŠ¥**: å……ç”µå®Œæˆæˆ–å¼‚å¸¸æé†’

### è‡ªå®šä¹‰æŸ¥è¯¢
ç”¨æˆ·å¯ä»¥é€šè¿‡ä¿®æ”¹Grafanaé¢æ¿çš„åŸå§‹SQLæŸ¥è¯¢ï¼Œåˆ›å»ºè‡ªå®šä¹‰çš„å¯è§†åŒ–è§†å›¾ï¼Œæ»¡è¶³ç‰¹å®šçš„åˆ†æéœ€æ±‚ã€‚

**Section sources**
- [drives.json](file://grafana/dashboards/drives.json)
- [drive-stats.json](file://grafana/dashboards/drive-stats.json)
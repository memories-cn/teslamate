# 数据可视化

<cite>
**本文档引用的文件**
- [datasource.yml](file://grafana/datasource.yml)
- [dashboards.yml](file://grafana/dashboards.yml)
- [battery-health.json](file://grafana/dashboards/battery-health.json)
- [drive-stats.json](file://grafana/dashboards/drive-stats.json)
- [charging-stats.json](file://grafana/dashboards/charging-stats.json)
- [charge-level.json](file://grafana/dashboards/charge-level.json)
- [charges.json](file://grafana/dashboards/charges.json)
- [overview.json](file://grafana/dashboards/overview.json)
- [statistics.json](file://grafana/dashboards/statistics.json)
- [timeline.json](file://grafana/dashboards/timeline.json)
</cite>

## 目录
1. [数据源配置](#数据源配置)
2. [预配置仪表板](#预配置仪表板)
3. [高级可视化技巧](#高级可视化技巧)
4. [查询优化](#查询优化)

## 数据源配置

TeslaMate 使用 Grafana 进行数据可视化，其数据源配置在 `grafana/datasource.yml` 文件中定义。该配置将 Grafana 连接到一个 PostgreSQL 数据库，使用环境变量来动态设置连接参数，确保了配置的灵活性和安全性。

数据源配置的关键参数包括：
- **名称 (name)**: 数据源在 Grafana 中的名称，此处为 "TeslaMate"。
- **类型 (type)**: 指定数据源类型为 `postgres`。
- **URL (url)**: 通过环境变量 `$DATABASE_HOST:$DATABASE_PORT` 动态设置数据库主机和端口。
- **用户 (user)**: 通过环境变量 `$DATABASE_USER` 设置数据库用户名。
- **密码 (password)**: 在 `secureJsonData` 部分通过环境变量 `$DATABASE_PASS` 设置，确保密码不会以明文形式存储。
- **数据库 (database)**: 在 `jsonData` 部分通过环境变量 `$DATABASE_NAME` 指定要连接的数据库名。
- **SSL 模式 (sslmode)**: 同样通过环境变量 `$DATABASE_SSL_MODE` 配置，以支持安全连接。

此配置作为 Grafana 的默认数据源 (`isDefault: true`)，所有仪表板都将默认使用此数据源进行查询。

**Section sources**
- [datasource.yml](file://grafana/datasource.yml#L1-L20)

## 预配置仪表板

TeslaMate 提供了一系列预配置的 Grafana 仪表板，用于监控和分析车辆数据。这些仪表板通过 `grafana/dashboards.yml` 文件进行组织，该文件定义了仪表板的提供者（provisioners），将文件系统中的 JSON 文件自动加载到 Grafana 的特定文件夹中。

### 电池健康 (Battery Health)

`battery-health.json` 仪表板专注于评估车辆的电池健康状况。其核心指标包括：

- **电池容量 (Battery Capacity)**: 显示当前可用电池容量（"Usable (now)"）和新车时的电池容量（"Usable (new)"），通过比较两者来估算电池退化程度。
- **电池健康 (Battery Health)**: 以条形图形式直观展示电池健康百分比，颜色从绿色（健康）到红色（严重退化）渐变。
- **AC/DC - 能量使用 (AC/DC - Energy Used)**: 饼图显示通过交流（AC）和直流（DC）充电所消耗的总能量占比，帮助用户了解充电习惯。

该仪表板利用了 `$custom_kwh_new` 和 `$custom_max_range` 等自定义变量，允许用户手动输入新车时的电池容量和最大续航里程，以获得更精确的健康度估算。

**Section sources**
- [battery-health.json](file://grafana/dashboards/battery-health.json#L1-L800)

### 驾驶统计 (Drive Stats)

`drive-stats.json` 仪表板提供了关于车辆驾驶活动的详细统计信息。主要功能包括：

- **驾驶次数 (# of Drives)**: 统计选定时间范围内的总驾驶次数。
- **总行驶距离 (Total Distance logged)**: 显示在选定时间范围内记录的总行驶距离。
- **总能量消耗 (Total Energy consumed)**: 计算驾驶过程中消耗的净能量。
- **平均速度 (Ø Speed)**: 展示单次驾驶中的最高速度。

该仪表板通过将多个查询结果（如驾驶次数、距离、能量消耗）组合在一个统计面板中，实现了信息的集中展示。

**Section sources**
- [drive-stats.json](file://grafana/dashboards/drive-stats.json#L1-L800)

### 充电分析 (Charging Stats)

`charging-stats.json` 仪表板是充电数据的核心分析工具。它提供了丰富的充电指标：

- **充电次数 (# of Charges)**: 统计充电会话的总数。
- **总充电量 (Total Energy added)**: 显示添加到电池中的总能量。
- **充电成本 (Charging Cost)**: 分别统计超级充电（SuC）和总充电成本。
- **每百公里成本 (Ø Cost per 100 $length_unit)**: 计算基于能量消耗和充电成本的综合行驶成本。

该仪表板还包含一个热图（Heatmap），用于可视化不同时间段的充电频率，帮助用户识别充电模式。

**Section sources**
- [charging-stats.json](file://grafana/dashboards/charging-stats.json#L1-L800)

### 电平 (Charge Level)

`charge-level.json` 仪表板以时间序列图的形式展示电池电量（SOC）随时间的变化。其特点包括：

- **实时电平**: 显示从车辆位置和充电记录中获取的电池电量。
- **可用电池电平**: 区分了总电池电量和实际可用的电量。
- **动态阈值**: 通过查询 `cars` 表中的 `lfp_battery` 字段，动态设置低电量（20%）、中等电量（80%或100%）和高电量（90%或100%）的阈值，为不同电池类型的车辆提供准确的视觉提示。

该仪表板还集成了移动平均和百分位数计算，以平滑数据并揭示长期趋势。

**Section sources**
- [charge-level.json](file://grafana/dashboards/charge-level.json#L1-L408)

### 仪表板间的导航关系

这些仪表板之间通过超链接紧密关联，形成了一个完整的数据探索路径。例如：
- 在 `overview.json` 仪表板中，点击 "Charge Level" 图表可以跳转到 `charge-level.json` 仪表板，查看更详细的电平变化。
- 在 `charges.json` 仪表板的表格中，点击 "Date" 列可以跳转到 `charge-details.json` 仪表板，查看单次充电的详细信息。
- 在 `timeline.json` 仪表板中，"Action" 列的链接允许用户直接跳转到对应驾驶、充电或行程的详细视图。

这种设计极大地提升了用户体验，使用户能够从宏观概览深入到微观细节。

**Section sources**
- [overview.json](file://grafana/dashboards/overview.json#L1-L800)
- [charges.json](file://grafana/dashboards/charges.json#L1-L800)
- [timeline.json](file://grafana/dashboards/timeline.json#L1-L759)

## 高级可视化技巧

### 变量与模板

Grafana 仪表板广泛使用了模板变量（Template Variables）来实现动态和交互式可视化。

- **$car_id**: 这是一个查询变量，通过执行 SQL 查询 `SELECT id as __value, name as __text FROM cars` 来填充，允许用户在拥有多个车辆时切换查看对象。
- **$length_unit 和 $temp_unit**: 这些变量从 `settings` 表中读取用户的首选单位（公里/英里，摄氏度/华氏度），并应用于所有相关面板，确保单位的一致性。
- **$period**: 在 `statistics.json` 仪表板中，此变量允许用户选择按天、周、月或年来聚合统计数据。

### 警报配置

虽然提供的仪表板文件中未直接包含警报规则，但可以通过 Grafana 的警报功能基于这些数据创建。例如，可以为 `battery-health.json` 仪表板中的 "Battery Health" 指标设置警报，当健康度低于 90% 时触发通知。

## 查询优化

为了确保仪表板的性能，TeslaMate 的仪表板查询经过了精心优化。

### 数据聚合与时间分组

对于长时间范围的数据，直接查询原始数据点会导致性能低下。因此，仪表板使用 `date_trunc` 函数将数据按小时、天或其他时间间隔进行分组。例如，在 `drive-stats.json` 中，通过 `date_trunc('day', start_date)` 将每日的驾驶次数聚合为一个数据点，显著减少了返回的数据量。

### 复杂查询的分解

一些复杂的分析（如净能耗和总能耗的计算）被分解为多个 CTE（Common Table Expressions）。例如，`statistics.json` 中的 `consumption_gross_$length_unit` 查询使用了多个 CTE 来分别处理驾驶、充电和停车期间的续航损失，最后再进行合并计算，使逻辑更清晰且易于维护。

### 避免重复计算

在 `statistics.json` 仪表板中，四个独立的查询（A, B, C, D）分别获取驾驶、充电、净能耗和总能耗的数据。然后，通过 Grafana 的 "merge" 和 "seriesToColumns" 转换，将这些结果合并到一个表格中。这种方法避免了在一个庞大的 SQL 查询中进行复杂的 JOIN 操作，提高了查询效率。

**Section sources**
- [statistics.json](file://grafana/dashboards/statistics.json#L1-L800)
- [drive-stats.json](file://grafana/dashboards/drive-stats.json#L1-L800)
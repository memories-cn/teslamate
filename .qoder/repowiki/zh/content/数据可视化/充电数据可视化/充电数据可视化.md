# 充电数据可视化

<cite>
**本文档引用的文件**   
- [charges.json](file://grafana/dashboards/charges.json)
- [charging-stats.json](file://grafana/dashboards/charging-stats.json)
- [charge-level.json](file://grafana/dashboards/charge-level.json)
- [vampire-drain.json](file://grafana/dashboards/vampire-drain.json)
- [charge-details.json](file://grafana/dashboards/internal/charge-details.json)
- [CreateChargingProcesses.exs](file://priv/repo/migrations/20190330190000_create_charging_processes.exs)
- [CreateCharges.exs](file://priv/repo/migrations/20190330200000_create_charges.exs)
- [AddFkeyIndexes.exs](file://priv/repo/migrations/20190717184003_add_fkey_indexes.exs)
- [DatabaseEfficiencyImprovements.exs](file://priv/repo/migrations/20200410112005_database_efficiency_improvements.exs)
- [log.ex](file://lib/teslamate/log.ex)
</cite>

## 目录
1. [引言](#引言)
2. [充电事件列表 (charges.json)](#充电事件列表-chargesjson)
3. [充电统计分析 (charging-stats.json)](#充电统计分析-charging-statsjson)
4. [电量变化曲线 (charge-level.json)](#电量变化曲线-charge-leveljson)
5. [幽灵耗电监测 (vampire-drain.json)](#幽灵耗电监测-vampire-drainjson)
6. [充电过程详细指标 (charge-details.json)](#充电过程详细指标-charge-detailsjson)
7. [PostgreSQL查询优化建议](#postgresql查询优化建议)

## 引言
本文档旨在全面解析TeslaMate项目中的充电数据可视化功能。通过分析Grafana仪表板的JSON配置文件，我们将深入探讨充电事件的记录、统计、可视化以及相关的数据库查询优化策略。文档将详细解释`charges.json`、`charging-stats.json`、`charge-level.json`、`vampire-drain.json`和`charge-details.json`等核心仪表板的结构与功能，为用户提供一个清晰、全面的充电数据可视化指南。

## 充电事件列表 (charges.json)

`charges.json` 仪表板提供了用户充电事件的概览和详细列表。该仪表板的顶部包含四个关键统计信息，分别展示所选时间段内的总充电能量、总能耗、总充电成本和平均充电时长。这些统计信息通过`stat`类型的面板实现，其数据来源于`charging_processes`表，并通过`sum`和`mean`等聚合函数进行计算。

仪表板的核心是一个数据表格，它列出了所有符合条件的充电事件。表格的每一行代表一次完整的充电过程，其数据来源于`charging_processes`表，并通过`LEFT JOIN`关联`addresses`和`geofences`表以获取位置信息。表格中的关键字段包括：
- **Date (日期)**: 充电开始时间，链接到`charge-details.json`仪表板以查看详细信息。
- **Energy added (增加的能量)**: 本次充电过程中增加的电量（kWh）。
- **% Start / % End (起始/结束电量百分比)**: 充电开始和结束时的电池电量百分比。
- **Duration (时长)**: 充电持续时间（分钟）。
- **Temp (温度)**: 充电期间的平均外部温度，根据温度值使用不同颜色显示。
- **Cost (成本)**: 充电成本，可点击链接进行设置。
- **Location (位置)**: 充电地点，可点击链接创建或编辑地理围栏。
- **Range gained (增加的续航)**: 充电后增加的续航里程。

**Section sources**
- [charges.json](file://grafana/dashboards/charges.json#L1-L1526)

## 充电统计分析 (charging-stats.json)

`charging-stats.json` 仪表板专注于对充电数据进行深入的统计分析。该仪表板为每辆车（通过`car_id`变量）创建一个独立的行，以便进行多车对比。

仪表板的上半部分展示了多个关键的统计指标：
- **# of Charges**: 充电次数。
- **Total Energy added**: 总充电能量。
- **SuC Charging Cost**: 超级充电站（Supercharger）的充电成本。
- **Total Charging Cost**: 总充电成本。
- **Ø Cost per 100 $length_unit**: 每100单位长度（公里或英里）的平均成本。
- **Ø Cost per kWh**: 每千瓦时的平均成本，以及分别针对直流（DC）和交流（AC）充电的平均成本。

这些指标通过`stat`面板和复杂的SQL查询实现。例如，`Total Energy added`使用`sum(charge_energy_added)`来计算总和。而`Ø Cost per kWh`则通过`sum(cost) / sum(greatest(charge_energy_added, charge_energy_used))`来计算加权平均成本。

仪表板的下半部分使用热力图（heatmap）来可视化充电事件的分布情况。热力图的X轴为时间（按周分组），Y轴为电池电量百分比（0-100%），颜色深浅表示在特定时间和电量区间内充电事件的频率。这有助于用户识别充电习惯，例如是否倾向于在电量较低时充电。

**Section sources**
- [charging-stats.json](file://grafana/dashboards/charging-stats.json#L1-L2418)

## 电量变化曲线 (charge-level.json)

`charge-level.json` 仪表板的核心是一个时间序列图，用于展示车辆电池电量随时间的变化曲线。该图的数据来源于`positions`表，该表记录了车辆在不同时间点的位置和状态信息。

图表的主要数据系列是“Battery Level”（电池电量）和“Usable Battery Level”（可用电池电量）。查询通过`date_bin`函数对时间进行分组（默认为2分钟），并计算每个时间区间内的平均电量，以减少数据量并平滑曲线。

该仪表板的一个独特功能是计算并显示电量的移动平均值和百分位数。通过一个复杂的CTE（公用表表达式）查询，系统对数据进行分桶、填充缺失值（使用前向填充法），然后计算指定时间窗口内的7.5%、50%（中位数）和92.5%百分位数。这有助于用户识别电量的典型范围和异常波动。

此外，图表还通过`transformations`配置，从`cars`和`car_settings`表中动态获取电池的上下限阈值（例如，LFP电池为20%-100%，三元锂电池为20%-80%），并在图表中以绿色区域高亮显示，为用户提供直观的充电建议。

**Section sources**
- [charge-level.json](file://grafana/dashboards/charge-level.json#L1-L408)

## 幽灵耗电监测 (vampire-drain.json)

`vampire-drain.json` 仪表板专门用于监测车辆在停放期间的“幽灵耗电”（Vampire Drain）现象，即车辆因后台系统运行而产生的非驾驶性电量消耗。

该仪表板的核心是一个数据表格，它通过一个复杂的SQL查询识别出车辆在两次行程或充电之间长时间停放的时段。查询的关键逻辑是：
1.  **合并数据**: 将`drives`（行程）和`charging_processes`（充电过程）表的数据合并，形成一个按时间排序的事件流。
2.  **计算间隔**: 使用`lag()`窗口函数，计算当前事件的开始时间与上一个事件的结束时间之间的间隔。
3.  **筛选条件**: 只保留那些间隔时间超过用户设定阈值（默认6小时）且车辆未移动的时段。

表格中的关键指标包括：
- **Start / End (开始/结束)**: 停放时段的起止时间。
- **Period (时长)**: 停放总时长。
- **Standby (待机)**: 车辆处于`asleep`或`offline`状态的时间占总时长的比例。
- **Range loss (续航损失)**: 停放期间损失的续航里程。
- **Ø Range loss / h (每小时续航损失)**: 平均每小时的续航损失。
- **Energy drained (消耗的能量)**: 停放期间消耗的电量（kWh）。
- **Ø Power (平均功率)**: 停放期间的平均耗电功率（W）。
- **❄**: 一个特殊列，当系统检测到因低温导致续航估算不准确时，会显示雪花图标。

**Section sources**
- [vampire-drain.json](file://grafana/dashboards/vampire-drain.json#L1-L655)

## 充电过程详细指标 (charge-details.json)

`charge-details.json` 仪表板提供了单次充电过程的最详细视图。该仪表板通过`$charging_process_id` URL参数接收一个特定的充电过程ID，并展示其所有相关数据。

仪表板的核心是一个时间序列图，它将多个关键指标绘制在同一张图上，便于用户分析它们之间的关系。这些指标包括：
- **SOC (State of Charge)**: 电池电量百分比。
- **Power (功率)**: 充电功率（kW）。
- **Charging Voltage (充电电压)**: 充电电压（V）。
- **Current (电流)**: 实际充电电流（A）。
- **Current (pilot) (导引电流)**: 导引电流（A）。
- **Phases (相数)**: 充电相数。
- **Outdoor Temperature (户外温度)**: 外部环境温度。
- **Battery heater (电池加热器)**: 电池加热器状态（开启/关闭）。
- **Range (续航)**: 车辆的预估续航里程。

这些数据直接来源于`charges`表，该表记录了充电过程中每分钟（或更短间隔）的详细状态。查询使用`$__time(date)`宏来过滤时间范围，并通过`join`关联`charging_processes`表以获取车辆信息。

除了主图，仪表板还包含多个`stat`面板，用于展示本次充电的摘要信息：
- **Cost (成本)**: 从`charging_processes`表中获取。
- **Duration (时长)**: 通过计算`charges`表中最早和最晚记录的时间差得出。
- **Charge Energy (充电能量)**: 显示“Added”（增加的能量）、“Used”（消耗的能量）和“Efficiency”（效率）。
- **Battery Level (电池电量)**: 显示充电开始、增加和结束时的电量。
- **Ranges ($preferred_range)**: 显示充电开始、增加和结束时的续航里程。

**Section sources**
- [charge-details.json](file://grafana/dashboards/internal/charge-details.json#L1-L1903)

## PostgreSQL查询优化建议

基于对TeslaMate项目数据库模式和查询的分析，以下是针对大规模充电数据查询的PostgreSQL优化建议：

### 1. 利用现有索引
项目已通过`AddFkeyIndexes.exs`等迁移文件创建了关键的外键索引。确保查询充分利用这些索引：
- 在`charging_processes`表上，对`car_id`、`position_id`和`address_id`的查询会自动使用索引。
- 在`charges`表上，对`charging_process_id`的查询会使用索引。
- **建议**: 在编写查询时，始终以这些索引列为过滤条件（WHERE子句）的起点。

### 2. 优化数据类型和精度
`DatabaseEfficiencyImprovements.exs`迁移文件展示了通过优化数据类型来提升性能的策略：
- 将`cars.id`从默认的`:integer`改为`:smallint`，因为车辆数量通常不会超过32767。
- 对浮点数字段（如`charge_energy_added`）使用`numeric(precision, scale)`而非`float`，以提高精度和存储效率。
- **建议**: 对于其他高频率写入的表（如`positions`），可以考虑类似的数据类型优化，例如将经纬度的精度从`precision: 9, scale: 6`调整为满足需求的最小值。

### 3. 优化复杂查询
`charge-level.json`中的百分位数查询是一个典型的复杂查询。它通过分桶（bucketing）和前向填充（gap-filling）来处理不规则采样的数据。
- **建议**: 对于类似的分析查询，可以考虑创建物化视图（Materialized View）来预先计算和存储结果。例如，可以创建一个物化视图，每天计算一次过去30天的电量移动平均值和百分位数，从而将实时计算的开销转移到后台任务。

### 4. 启用并监控`pg_stat_statements`
`database-info.json`仪表板包含了对`pg_stat_statements`扩展的查询，这表明该项目支持性能监控。
- **建议**: 在生产环境中启用`pg_stat_statements`扩展。定期运行`SELECT query, calls, mean_exec_time, total_exec_time FROM pg_stat_statements ORDER BY mean_exec_time DESC LIMIT 10;`来识别最耗时的查询，并对其进行优化（如添加索引、重写查询逻辑）。

### 5. 避免在时间戳上进行函数转换
在`log.ex`文件中，`determine_phases/1`函数使用了`avg(c.charger_power * 1000.0 / nullif(c.charger_actual_current * c.charger_voltage, 0))`来计算相数。这种在WHERE或JOIN条件中对列进行计算的操作会阻止索引的使用。
- **建议**: 如果可能，将计算结果存储在数据库的计算列（Generated Column）中，并为该列创建索引。例如，可以为`charges`表添加一个`calculated_power`列，并为其创建索引。

**Section sources**
- [AddFkeyIndexes.exs](file://priv/repo/migrations/20190717184003_add_fkey_indexes.exs#L1-L23)
- [DatabaseEfficiencyImprovements.exs](file://priv/repo/migrations/20200410112005_database_efficiency_improvements.exs#L1-L111)
- [log.ex](file://lib/teslamate/log.ex#L543-L580)
- [database-info.json](file://grafana/dashboards/database-info.json#L1468-L1735)
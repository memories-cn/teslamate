# 车辆状态可视化

<cite>
**本文档引用的文件**   
- [states.json](file://grafana/dashboards/states.json)
- [battery-health.json](file://grafana/dashboards/battery-health.json)
- [projected-range.json](file://grafana/dashboards/projected-range.json)
- [mileage.json](file://grafana/dashboards/mileage.json)
- [updates.json](file://grafana/dashboards/updates.json)
- [state.ex](file://lib/tesla_api/vehicle/state.ex)
- [log/state.ex](file://lib/teslamate/log/state.ex)
- [log/update.ex](file://lib/teslamate/log/update.ex)
- [convert.ex](file://lib/teslamate/convert.ex)
- [summary.html.heex](file://lib/teslamate_web/live/car_live/summary.html.heex)
</cite>

## 目录
1. [引言](#引言)
2. [车辆状态监控](#车辆状态监控)
3. [电池健康度分析](#电池健康度分析)
4. [续航预测模型](#续航预测模型)
5. [里程统计](#里程统计)
6. [系统更新记录](#系统更新记录)
7. [数据来源与计算](#数据来源与计算)
8. [自定义监控视图](#自定义监控视图)

## 引言
本文档详细介绍了TeslaMate系统中车辆状态可视化的实现机制，重点阐述了车辆健康和状态监控功能。文档涵盖了车辆实时状态监控、电池健康度分析、续航预测、里程统计以及系统更新记录等核心功能。通过分析Grafana仪表板配置和后端数据处理逻辑，解释了这些仪表板如何利用Tesla API数据和本地计算来提供准确的状态信息，并提供自定义状态监控视图的指导。

## 车辆状态监控
车辆状态监控仪表板（states.json）提供了车辆实时状态的全面视图，包括在线、离线、休眠等状态的实时变化。

该仪表板通过查询数据库中的`states`表来获取车辆的最新状态信息。仪表板中的"Last state change"和"Current State"面板使用SQL查询获取车辆最近一次状态变更的时间和当前状态。核心查询语句如下：
```sql
select $__time(start_date), state from states where car_id = $car_id order by start_date desc limit 1;
```

状态时间线（State Timeline）面板通过合并多个数据源来构建完整的车辆状态历史：
- 从`charging_processes`表获取充电状态
- 从`drives`表获取驾驶状态
- 从`states`表获取在线/离线/休眠状态
- 从`updates`表获取系统更新状态

这些状态被映射为不同的数值（如2=充电，1=驾驶，3=离线，4=休眠，5=在线，6=更新），并在时间线上以不同颜色显示，为用户提供直观的状态变化历史。

**Section sources**
- [states.json](file://grafana/dashboards/states.json#L1-L517)
- [log/state.ex](file://lib/teslamate/log/state.ex#L1-L32)

## 电池健康度分析
电池健康度分析仪表板（battery-health.json）提供了对车辆电池健康状况的深入分析，包括电池容量估算、健康度评估和退化情况。

该仪表板的核心是通过分析充电会话数据来估算电池的当前可用容量和新电池容量。"Battery Capacity"面板显示了两个关键指标：
- **Usable (now)**：当前可用电池容量，基于最近10次充电会话的平均估算值
- **Usable (new)**：车辆新电池时的估算容量

电池健康度（Battery Health）通过以下公式计算：
```
健康度(%) = 当前容量 / 新电池容量 × 100%
```

退化程度（Degradation）则通过以下公式计算：
```
退化(%) = 100% - (当前容量 / 新电池容量 × 100%)
```

用户可以通过"Custom Battery Capacity (kWh) when new"和"Custom Max Range when new"输入框手动设置新电池时的容量和最大续航，以提高估算的准确性。

AC/DC能量使用饼图通过分析充电过程中的相位信息来区分交流（AC）和直流（DC）充电，并计算各自的能量使用情况。

**Section sources**
- [battery-health.json](file://grafana/dashboards/battery-health.json#L1-L1750)

## 续航预测模型
续航预测模型（projected-range.json）通过分析车辆的电池范围数据和电池水平来预测车辆的续航里程。

该模型基于两种电池范围数据：
- **Rated Range**（额定续航）：基于车辆额定效率计算的续航
- **Ideal Range**（理想续航）：基于车辆理想效率计算的续航

仪表板通过以下SQL查询计算投影续航：
```sql
SELECT
  $__timeGroup(date, $interval) AS time,
  convert_km((sum(${preferred_range}_battery_range_km) / nullif(sum(coalesce(usable_battery_level,battery_level)),0) * 100)::numeric, '$length_unit') AS "Projected ${preferred_range} range [$length_unit]"
FROM
  (
    select battery_level, usable_battery_level, date,
      rated_battery_range_km, ideal_battery_range_km, outside_temp
    from positions
    where
      car_id = $car_id and $__timeFilter(date) and ideal_battery_range_km is not null
    union all
    select battery_level, coalesce(usable_battery_level,battery_level) as usable_battery_level, date,
      rated_battery_range_km, ideal_battery_range_km, outside_temp
    from charges c
    join
      charging_processes p ON p.id = c.charging_process_id 
    where
      $__timeFilter(date) and p.car_id = $car_id
  ) as data
GROUP BY
  1
having convert_km((sum(${preferred_range}_battery_range_km) / nullif(sum(coalesce(usable_battery_level,battery_level)),0) * 100)::numeric, '$length_unit') is not null
ORDER BY
  1,2  DESC
```

该查询从`positions`表和`charges`表中获取数据，计算每100%电池电量对应的续航里程，并将其转换为用户指定的单位（公里或英里）。

**Section sources**
- [projected-range.json](file://grafana/dashboards/projected-range.json#L1-L761)

## 里程统计
里程统计仪表板（mileage.json）提供了车辆行驶里程的详细统计信息。

该仪表板通过查询`drives`表中的起始和结束里程数据来计算总行驶里程。核心查询语句如下：
```sql
WITH o AS (SELECT
  start_date AS time,
  car_id,
  start_km  AS "odometer"
FROM drives
UNION ALL
SELECT
  end_date,
  car_id,
  end_km AS "odometer"
FROM drives)
SELECT
  time, 
  convert_km(odometer::numeric, '$length_unit') as mileage_$length_unit
FROM o
WHERE
  car_id = $car_id AND
  $__timeFilter(time)
order by 1;
```

该查询使用CTE（公用表表达式）将每次行程的起始和结束里程合并为一个数据集，然后按时间排序，形成连续的里程变化曲线。`convert_km`函数用于将里程单位转换为用户指定的单位。

**Section sources**
- [mileage.json](file://grafana/dashboards/mileage.json#L1-L282)

## 系统更新记录
系统更新记录仪表板（updates.json）跟踪和显示车辆的软件更新历史。

该仪表板的主要功能包括：
- 统计指定时间范围内的更新次数
- 计算更新之间的中位时间间隔
- 显示详细的更新记录表

更新记录表包含以下关键信息：
- **Date**（日期）：更新开始时间
- **Duration**（持续时间）：更新所花费的时间
- **Since Previous Update**（距上次更新）：与上次更新的时间间隔
- **Installed Version**（安装版本）：安装的软件版本号，包含指向发布说明的链接
- **# of Charges**（充电次数）：两次更新之间的充电次数
- **Ø Ideal range**（平均理想续航）：更新期间的平均理想续航

中位时间间隔通过PostgreSQL的`percentile_disc`函数计算：
```sql
SELECT percentile_disc(0.5) WITHIN GROUP (ORDER BY since_last_update) FROM (
  SELECT extract(EPOCH FROM start_date - lag(start_date) OVER (ORDER BY start_date)) AS since_last_update
  FROM updates
  WHERE $__timeFilter(start_date) AND car_id = $car_id
) d;
```

**Section sources**
- [updates.json](file://grafana/dashboards/updates.json#L1-L608)

## 数据来源与计算
车辆状态数据主要来源于Tesla API和本地数据库计算。

### Tesla API数据
系统通过Tesla API获取车辆的实时状态数据，主要包括：
- **充电状态**（Charge State）：包含`battery_level`（电池水平）、`usable_battery_level`（可用电池水平）、`ideal_battery_range`（理想续航）、`rated_battery_range`（额定续航）等字段
- **车辆状态**（Vehicle State）：包含`odometer`（里程表）、`car_version`（车辆版本）等字段
- **驾驶状态**（Drive State）：包含`speed`（速度）、`shift_state`（档位状态）等字段

这些数据结构在`lib/tesla_api/vehicle/state.ex`文件中定义，确保了数据的类型安全和一致性。

### 本地计算
系统在本地进行多种数据计算和转换：
- **单位转换**：通过`lib/teslamate/convert.ex`文件中的函数实现公里与英里、摄氏度与华氏度之间的转换
- **效率计算**：根据行驶距离和电池消耗计算车辆效率
- **状态推断**：根据API数据推断车辆的驾驶、充电、休眠等状态

例如，续航预测的计算逻辑在前端模板`summary.html.heex`中实现：
```elixir
r100 = current_range / tooltip_battery_level * 100
```

**Section sources**
- [state.ex](file://lib/tesla_api/vehicle/state.ex#L1-L396)
- [convert.ex](file://lib/teslamate/convert.ex#L1-L53)
- [summary.html.heex](file://lib/teslamate_web/live/car_live/summary.html.heex#L340-L359)

## 自定义监控视图
用户可以通过以下方式自定义状态监控视图：

### 添加新的监控指标
1. 在Grafana中编辑现有仪表板或创建新仪表板
2. 添加新的面板（Panel）
3. 配置数据源为TeslaMate PostgreSQL数据库
4. 编写SQL查询以获取所需指标
5. 配置可视化选项（如图表类型、颜色、单位等）

例如，要添加一个显示平均充电功率的指标，可以使用以下SQL查询：
```sql
SELECT 
  $__timeGroup(start_date, $interval) AS time,
  avg(charger_power) AS "Average Charging Power (kW)"
FROM charging_processes 
WHERE car_id = $car_id AND $__timeFilter(start_date)
GROUP BY 1
ORDER BY 1
```

### 设置健康警报
1. 在Grafana中选择要设置警报的面板
2. 进入面板的"Alert"（警报）设置
3. 配置警报条件，例如：
   - 当电池健康度低于90%时触发警报
   - 当连续7天行驶里程为0时触发警报
   - 当车辆离线超过24小时时触发警报
4. 配置警报通知方式（如邮件、Webhook等）

### 自定义电池健康度计算
用户可以通过修改`battery-health.json`仪表板中的变量来调整电池健康度计算：
- 设置"Custom Battery Capacity (kWh) when new"以指定新电池时的容量
- 设置"Custom Max Range when new"以指定新电池时的最大续航
- 调整用于计算的充电会话数量

这些自定义设置使得用户可以根据自己的车辆历史和使用情况，获得更准确的电池健康度评估。

**Section sources**
- [battery-health.json](file://grafana/dashboards/battery-health.json#L1-L1750)
- [states.json](file://grafana/dashboards/states.json#L1-L517)
- [projected-range.json](file://grafana/dashboards/projected-range.json#L1-L761)
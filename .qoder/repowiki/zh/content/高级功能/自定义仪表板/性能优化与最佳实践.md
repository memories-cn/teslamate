# 性能优化与最佳实践

<cite>
**本文档引用的文件**  
- [dashboards.yml](file://grafana/dashboards.yml)
- [datasource.yml](file://grafana/datasource.yml)
- [database-info.json](file://grafana/dashboards/database-info.json)
- [20230417225712_composite_index_to_position.exs](file://priv/repo/migrations/20230417225712_composite_index_to_position.exs)
- [20240915193446_composite_index_with_predicate_to_position.exs](file://priv/repo/migrations/20240915193446_composite_index_with_predicate_to_position.exs)
- [custom_expressions.ex](file://lib/teslamate/custom_expressions.ex)
- [runtime.exs](file://config/runtime.exs)
- [development.mdx](file://website/docs/development.mdx)
</cite>

## 目录
1. [引言](#引言)
2. [Grafana配置优化](#grafana配置优化)
3. [PostgreSQL查询优化](#postgresql查询优化)
4. [仪表板性能调优](#仪表板性能调优)
5. [监控与诊断](#监控与诊断)
6. [总结](#总结)

## 引言
本文档旨在为TeslaMate系统的Grafana仪表板提供全面的性能优化指导。通过分析dashboards.yml和datasource.yml配置文件，结合PostgreSQL数据库的索引策略和查询优化技术，帮助用户提升仪表板加载速度、降低系统资源消耗，并确保数据刷新的高效性。文档将涵盖从配置调整到复杂面板优化的各个方面，为用户提供实用的性能优化方案。

## Grafana配置优化

### 仪表板加载配置分析
dashboards.yml文件定义了Grafana仪表板的加载机制，其中`updateIntervalSeconds: 86400`设置了一天的更新间隔。这种配置适用于静态仪表板，但对于需要实时数据的仪表板可能需要调整。配置中定义了三个提供者：TeslaMate、Internal和Reports，分别对应不同的仪表板文件夹，这种组织方式有助于管理不同类型的仪表板。

datasource.yml文件配置了PostgreSQL数据源，使用环境变量进行连接参数的动态注入，如`$DATABASE_HOST:$DATABASE_PORT`和`$DATABASE_PASS`。这种配置方式提高了部署的灵活性，允许在不同环境中轻松切换数据库连接。数据源设置为默认数据源（isDefault: true），确保所有新面板默认使用此数据源。

**Section sources**
- [dashboards.yml](file://grafana/dashboards.yml#L1-L34)
- [datasource.yml](file://grafana/datasource.yml#L1-L20)

## PostgreSQL查询优化

### 复合索引策略
项目中的迁移文件展示了精心设计的复合索引策略。20230417225712_composite_index_to_position.exs迁移创建了`[:drive_id, :date]`的复合索引，同时删除了单一的`[:drive_id]`索引。这种优化减少了索引维护开销，同时提高了基于行程和日期范围查询的性能。

更高级的索引优化体现在20240915193446_composite_index_with_predicate_to_position.exs迁移中，该文件创建了一个带条件的复合索引：
```elixir
create index(:positions, [:car_id, :date, "(ideal_battery_range_km IS NOT NULL)"],
         where: "ideal_battery_range_km IS NOT NULL"
       )
```
这种部分索引（partial index）只包含满足特定条件的行，显著减小了索引大小，提高了查询效率，特别适用于过滤掉流式API数据的查询场景。

### 避免全表扫描
根据development.mdx文档中的最佳实践，应避免对positions表进行全表扫描。该表存储了车辆的详细位置数据，数据量巨大（每辆车每3万公里约1GB）。文档建议仅在必要时查询此表，并通过添加`ideal_battery_range_km IS NOT NULL and car_id = $car_id`作为WHERE条件来排除流式数据，从而减少查询的数据量。

**Section sources**
- [20230417225712_composite_index_to_position.exs](file://priv/repo/migrations/20230417225712_composite_index_to_position.exs#L1-L9)
- [20240915193446_composite_index_with_predicate_to_position.exs](file://priv/repo/migrations/20240915193446_composite_index_with_predicate_to_position.exs#L1-L10)
- [development.mdx](file://website/docs/development.mdx#L168-L174)

## 仪表板性能调优

### 查询间隔与缓存
Grafana仪表板中的变量配置，如charge-level.json中的`intervals_moving_average_percentiles`，允许用户控制移动平均线的宽度。通过设置适当的查询间隔，可以平衡数据精度和查询性能。建议根据数据的时间跨度选择合适的间隔，避免在长时间范围内使用过短的间隔。

Grafana的缓存机制可以通过合理设置数据源的缓存选项来利用。对于不经常变化的数据，可以增加缓存时间，减少对数据库的直接查询。同时，限制返回的数据点数量是提高性能的关键，特别是在显示趋势线时，过多的数据点会导致渲染缓慢。

### 复杂面板优化
复杂面板如地理空间地图或长周期趋势线对性能影响显著。对于地理空间查询，custom_expressions.ex文件中的`within_geofence?`宏使用了PostgreSQL的地球距离函数，这些计算密集型操作应谨慎使用。建议在可能的情况下，预先计算地理围栏状态并存储在数据库中，而不是在查询时实时计算。

对于长周期趋势线，可以考虑使用预聚合数据或物化视图，而不是直接查询原始数据。这可以显著减少查询时间和资源消耗，特别是在处理大量历史数据时。

**Section sources**
- [charge-level.json](file://grafana/dashboards/charge-level.json#L358-L380)
- [custom_expressions.ex](file://lib/teslamate/custom_expressions.ex#L37-L78)

## 监控与诊断

### 数据库负载监控
database-info.json仪表板提供了全面的数据库监控功能。该仪表板包含多个关键指标，如表大小、行数统计和索引效率。通过监控这些指标，可以及时发现性能瓶颈，如索引膨胀（index bloat），这通常发生在大量更新或删除操作后。

仪表板中的查询使用了PostgreSQL的系统视图，如`pg_catalog.pg_statio_user_tables`和`information_schema.tables`，来获取数据库的物理统计信息。这些信息对于评估索引效率和数据库整体健康状况至关重要。

### 查询性能分析
development.mdx文档建议启用pg_stat_statements扩展来收集查询统计信息。通过分析`mean_exec_time`等指标，可以识别出执行时间最长的查询，从而有针对性地进行优化。文档提供了具体的配置步骤，包括在Docker配置中预加载pg_stat_statements模块和创建相应的扩展。

```sql
SELECT query, calls, mean_exec_time, total_exec_time FROM pg_stat_statements ORDER BY mean_exec_time DESC LIMIT 10;
```
这个查询可以帮助快速定位性能瓶颈，是诊断和优化查询性能的重要工具。

**Section sources**
- [database-info.json](file://grafana/dashboards/database-info.json#L1-L800)
- [development.mdx](file://website/docs/development.mdx#L177-L202)

## 总结
TeslaMate系统的性能优化需要从多个层面进行综合考虑。通过合理配置Grafana的加载机制和数据源，优化PostgreSQL的索引策略和查询方式，以及对复杂仪表板进行针对性调优，可以显著提升系统的整体性能。同时，建立有效的监控和诊断机制，能够及时发现和解决性能问题，确保系统在高负载下依然保持稳定和高效。
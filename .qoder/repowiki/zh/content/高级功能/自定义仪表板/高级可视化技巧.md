# 高级可视化技巧

<cite>
**本文档引用的文件**
- [charge-details.json](file://grafana/dashboards/internal/charge-details.json)
- [drive-details.json](file://grafana/dashboards/internal/drive-details.json)
- [dutch-tax.json](file://grafana/dashboards/reports/dutch-tax.json)
- [charging-stats.json](file://grafana/dashboards/charging-stats.json)
- [drive-stats.json](file://grafana/dashboards/drive-stats.json)
- [mileage.json](file://grafana/dashboards/mileage.json)
</cite>

## 目录
1. [引言](#引言)
2. [内部视图分析](#内部视图分析)
3. [法规报告构建](#法规报告构建)
4. [统计聚合方法](#统计聚合方法)
5. [里程计算逻辑](#里程计算逻辑)
6. [自定义报告扩展](#自定义报告扩展)

## 引言
本文档深入探讨TeslaMate中高级仪表板和内部视图的设计模式与实现技巧。通过分析`internal`目录下的`charge-details.json`和`drive-details.json`文件，揭示其作为底层数据探索工具的核心作用。同时，解析`dutch-tax.json`报告的结构，展示如何构建符合特定法规要求的数据报表。详细讲解`charging-stats.json`和`drive-stats.json`中的统计聚合方法，包括使用PostgreSQL窗口函数和时间序列分析。介绍`mileage.json`中里程累计的计算逻辑，并指导用户如何复制和扩展这些高级模式，创建自定义报告。

## 内部视图分析
TeslaMate的`internal`目录包含`charge-details.json`和`drive-details.json`两个核心文件，它们作为底层数据探索工具，为用户提供详细的充电和驾驶过程分析。

`charge-details.json`仪表板通过时间序列图展示了充电过程中的关键指标，包括电池电量（SOC）、充电功率、充电电压、电流、相位数和室外温度。该仪表板利用Grafana的geomap面板在地图上标记充电位置，帮助用户直观了解充电行为的地理分布。通过SQL查询，该仪表板从`charges`表和`charging_processes`表中提取数据，使用`$__timeFilter`变量实现时间范围过滤，并通过`convert_km`和`convert_celsius`等自定义函数进行单位转换。

`drive-details.json`仪表板则提供了驾驶过程的全面视图，包括速度、功率、电池电量、可用SOC、电池加热器状态和各种续航里程。该仪表板同样使用geomap面板显示驾驶路线，并通过时间序列图展示海拔变化和车内温度。通过复杂的SQL查询，该仪表板从`positions`表中提取数据，结合`convert_km`和`convert_m`等函数进行单位转换，为用户提供详细的驾驶数据分析。

**Section sources**
- [charge-details.json](file://grafana/dashboards/internal/charge-details.json)
- [drive-details.json](file://grafana/dashboards/internal/drive-details.json)

## 法规报告构建
`dutch-tax.json`报告展示了如何构建符合特定法规要求的数据报表。该报告采用表格形式，列出特定时间段内的所有驾驶记录，包括驾驶ID、开始和结束时间、起止里程、持续时间和距离。通过使用`WITH`子句和`UNION ALL`操作符，该报告将多个查询结果合并，确保数据的完整性和一致性。

该报告的SQL查询从`drives`表中提取数据，并通过`LEFT JOIN`操作符关联`addresses`表和`cars`表，获取起止地址和车辆信息。使用`CONCAT_WS`函数将地址的各个部分组合成完整的地址字符串，并通过`convert_km`函数进行单位转换。该报告还使用`ORDER BY`子句按驾驶ID降序排列，确保最新的驾驶记录显示在最前面。

**Section sources**
- [dutch-tax.json](file://grafana/dashboards/reports/dutch-tax.json)

## 统计聚合方法
`charging-stats.json`和`drive-stats.json`文件展示了TeslaMate中复杂的统计聚合方法，利用PostgreSQL窗口函数和时间序列分析技术。

`charging-stats.json`中的统计面板使用`count(*)`、`sum()`和`avg()`等聚合函数计算充电次数、总充电能量和平均充电成本。通过`WITH`子句和`generate_series`函数，该文件创建了一个时间序列基线，确保即使在没有数据的时间点也能显示零值。使用`LEAD`和`LAG`窗口函数，该文件计算了充电过程中的范围损失和能耗。

`drive-stats.json`中的统计面板同样使用`count(*)`、`sum()`和`avg()`等聚合函数计算驾驶次数、总行驶距离和总能耗。通过`percentile_cont`函数，该文件计算了驾驶距离的中位数。使用`EXTRACT(EPOCH FROM ...)`函数，该文件将时间差转换为秒数，便于计算驾驶持续时间。

**Section sources**
- [charging-stats.json](file://grafana/dashboards/charging-stats.json)
- [drive-stats.json](file://grafana/dashboards/drive-stats.json)

## 里程计算逻辑
`mileage.json`文件展示了TeslaMate中里程累计的计算逻辑。该文件使用时间序列图显示车辆的累计里程，通过`WITH`子句和`UNION ALL`操作符将起始和结束里程数据合并。使用`convert_km`函数进行单位转换，并通过`ORDER BY`子句按时间排序，确保里程数据的连续性。

该文件的SQL查询从`drives`表中提取起始和结束里程数据，并通过`start_date`和`end_date`字段关联时间。使用`$__timeFilter`变量实现时间范围过滤，确保只显示指定时间段内的里程数据。该文件还使用`convert_km`函数进行单位转换，支持公里和英里两种单位。

**Section sources**
- [mileage.json](file://grafana/dashboards/mileage.json)

## 自定义报告扩展
用户可以基于TeslaMate提供的高级模式，创建自定义报告。例如，可以创建基于地理位置的能耗分析报告，通过`positions`表中的`latitude`和`longitude`字段，结合`convert_km`函数，计算不同地理位置的能耗。可以创建按季节划分的充电成本对比报告，通过`EXTRACT(MONTH FROM ...)`函数提取月份信息，结合`sum()`函数计算各季节的充电成本。

通过复制和扩展`charging-stats.json`和`drive-stats.json`中的统计聚合方法，用户可以创建符合特定需求的自定义报告。例如，可以使用`WITH`子句和`generate_series`函数创建时间序列基线，使用`LEAD`和`LAG`窗口函数计算能耗变化，使用`percentile_cont`函数计算统计中位数。通过这些高级技巧，用户可以深入分析TeslaMate收集的数据，获得有价值的洞察。

**Section sources**
- [charging-stats.json](file://grafana/dashboards/charging-stats.json)
- [drive-stats.json](file://grafana/dashboards/drive-stats.json)
- [mileage.json](file://grafana/dashboards/mileage.json)